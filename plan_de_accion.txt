PLAN DE ACCIÓN: HU-15 - Gestión de Pagos (Mejoras Adicionales)

**OBJETIVO:** Implementar la funcionalidad para registrar pagos de facturas a crédito por parte de administradores y vendedores, y mejorar la visibilidad de la forma de pago en la lista de compras.

**TAREAS:**

1.  **Actualizar Formas de Pago en Módulo de Compras:**
    *   **Análisis:**
        *   Leer `FacturasSRI.Domain/Entities/CuentaPorPagar.cs` para entender la entidad de la deuda de compras.
        *   Leer `FacturasSRI.Domain/Entities/Compra.cs` para añadir la propiedad `FormaDePago`.
        *   Leer `FacturasSRI.Application/Dtos/PurchaseDto.cs` para incluir la `FormaDePago` en el DTO.
        *   Leer `FacturasSRI.Infrastructure/Services/PurchaseService.cs` para ver cómo se cargan las compras y dónde poblar el DTO.
        *   Leer `FacturasSRI.Web/Components/Pages/Purchases/ListPurchases.razor` para añadir la columna en la interfaz de usuario.
    *   **Implementación:**
        *   Modificar `FacturasSRI.Domain/Entities/Compra.cs`: Añadir `public FormaDePago FormaDePago { get; set; }`.
        *   Modificar `FacturasSRI.Application/Dtos/PurchaseDto.cs`: Añadir `public FormaDePago FormaDePago { get; set; }`.
        *   Modificar `FacturasSRI.Infrastructure/Services/PurchaseService.cs`:
            *   Actualizar el método `CreatePurchaseAsync` para asignar la `FormaDePago` al crear una nueva compra (por defecto `Contado` si no se especifica, o basarse en un nuevo campo en `CreatePurchaseDto`). Se necesitará un `FormaDePago` en `CreatePurchaseDto`.
            *   Actualizar el método `GetPurchasesAsync` para poblar el `FormaDePago` en el `PurchaseDto` resultante.
        *   Modificar `FacturasSRI.Web/Components/Pages/Purchases/ListPurchases.razor`: Añadir una nueva columna en la tabla para mostrar la `FormaDePago` de cada compra.

2.  **Implementar Registro de Pagos desde la Lista de Facturas (`ListInvoices.razor`):**
    *   **Crear Componente `RegisterPaymentModal.razor` (reutilizable):**
        *   Crear el archivo `FacturasSRI.Web/Components/Modals/RegisterPaymentModal.razor`.
        *   Este componente será un modal de Bootstrap que recibirá un `FacturaId` como parámetro.
        *   Tendrá un formulario para `Monto`, `MetodoDePago`, `Referencia` y `FechaCobro`.
        *   Inyectará `ICobroService` para llamar a `RegistrarCobroAsync`.
        *   Tendrá un evento `OnPaymentRegistered` para notificar al componente padre que un pago fue registrado exitosamente.
    *   **Modificar `FacturasSRI.Web/Components/Pages/Invoices/ListInvoices.razor`:**
        *   Añadir el componente `RegisterPaymentModal` al final del archivo.
        *   Implementar un estado `showRegistrarPagoModal` y `selectedFacturaId` para controlar la visibilidad del modal y la factura a la que se le registrará el pago.
        *   Añadir un botón "Registrar Pago" en la columna "Acciones" de la tabla. Este botón solo será visible si la factura tiene `FormaDePago.Credito` y `SaldoPendiente > 0` (se necesitará añadir `FormaDePago` y `SaldoPendiente` al `InvoiceDto` para esto).
        *   El botón abrirá el modal y le pasará el `FacturaId`.
        *   Implementar el manejo del evento `OnPaymentRegistered` para recargar la lista de facturas.

3.  **Refactorizar `InvoiceDetail.razor` para Reutilizar el Modal de Registro de Pagos:**
    *   Modificar `FacturasSRI.Web/Components/Pages/Invoices/InvoiceDetail.razor`:
        *   Eliminar el código HTML y la lógica de estado relacionados con el modal de registro de pagos.
        *   Reemplazarlo por una instancia del nuevo componente `RegisterPaymentModal`, pasándole el `InvoiceId` y manejando el evento `OnPaymentRegistered`.

**CONSIDERACIONES ADICIONALES:**

*   **CreatePurchaseDto:** Es probable que necesitemos añadir la `FormaDePago` también a `CreatePurchaseDto` para que el usuario pueda especificarla al registrar una compra.
*   **Migraciones:** Cada cambio en las entidades requerirá una nueva migración de Entity Framework.

**RECORDATORIO:** Sigue el principio de "proyecto universitario de 4to semestre" - soluciones claras y no excesivamente complejas.

Listo para tu aprobación y para comenzar a implementar.

---
**NUEVO PLAN DE ACCIÓN Y ACLARACIONES (22/11/2025) - Ronda 2**

¡Excelentes observaciones! Vamos a refinar la lógica para que sea más robusta y cumpla con un flujo de trabajo más realista.

**Decisión Tomada:**
*   **Escenario A (Pagos Parciales):** Has elegido este escenario. Perfecto, mantendremos la flexibilidad de registrar abonos a las facturas de crédito. El campo "Monto" seguirá siendo editable.

---

**ACLARACIONES Y PLAN PROPUESTO**

**1. Página "Historial de Pagos" y el botón "Ver Detalles"**

Tu idea de tener una vista de detalles para los pagos de una factura es muy buena. Sin embargo, la página actual de "Historial de Pagos" (`/payments`) muestra cada pago individualmente. Esto hace que un botón de "detalles" en cada fila sea un poco confuso.

**Propuesta de Flujo de Trabajo:**
Te propongo rediseñar ligeramente esta sección para que sea más intuitiva:

*   **Paso 1: Modificar la página `/payments` ("Historial de Pagos").** En lugar de mostrar una larga lista de pagos individuales, esta página mostrará una lista de **facturas que tienen pagos registrados**. Cada fila mostrará un resumen: Número de Factura, Cliente, Monto Total, Saldo Pendiente, etc.
*   **Paso 2: Botón "Ver Detalles de Pagos".** En cada fila de esta nueva lista, habrá un botón "Ver Detalles" o "Ver Pagos".
*   **Paso 3: Crear la página de detalles.** Este botón llevará a una nueva página, por ejemplo, `/payments/details/{FacturaId}`, donde se mostrarán **todos los pagos (abonos) de esa factura específica**, con su monto, fecha, referencia y un botón para descargar cada comprobante.

**¿Te parece bien este flujo?** Es más organizado y permite ver el historial completo de una factura de forma clara.

**2. Manejo de Métodos de Pago ("Otro")**

Tu observación sobre la opción "Otro" es correcta. Si la mantenemos, necesitamos un campo adicional para especificar de qué se trata.

**Propuesta:**
*   En el formulario para registrar un pago, si el usuario selecciona "Otro" de la lista desplegable, aparecerá dinámicamente un campo de texto para que pueda escribir el método de pago específico (ej: "Canje por servicio", "Crédito de la casa", etc.).

---

**PLAN DE ACCIÓN INMEDIATO (LO QUE HARÉ AHORA)**

Independientemente de tu respuesta a la pregunta del flujo de trabajo, puedo avanzar con las siguientes mejoras que son seguras:

1.  **Eliminar Fecha Manual:** Quitaré el campo de fecha del formulario de pago. La fecha se registrará automáticamente en el servidor (`DateTime.UtcNow`).
2.  **Mejorar Selección de Método de Pago:**
    *   Cambiaré el campo de texto de "Método de Pago" por una lista desplegable.
    *   Implementaré la lógica para que al seleccionar "Otro", aparezca un campo de texto adicional para especificar el método.

**Próximos Pasos:**
1.  **Espero tu confirmación** sobre la propuesta para el flujo de la página "Historial de Pagos".
2.  Mientras tanto, **comenzaré a implementar las mejoras 1 y 2** en el modal de registro de pago (`RegisterPaymentModal.razor`).

Quedo atento a tus comentarios.

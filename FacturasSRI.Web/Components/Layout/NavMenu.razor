@using Microsoft.AspNetCore.Components.Authorization
@using FacturasSRI.Web.Services
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject NavigationManager Navigation

<div class="nav-menu">
    <div class="nav-header">
        <a class="navbar-brand d-flex align-items-center" href="">
            <img src="logo.png" alt="Logo Aether Tech" style="height: 40px; margin-right: 10px;" />
            @if (!IsCollapsed) { <span>Aether Tech</span> }
        </a>
    </div>

    <nav class="nav-container">
        <AuthorizeView Roles="Administrador, Vendedor, Bodeguero" Context="staffContext">
            <Authorized>
                <div class="nav-item">
                    <NavLink class="nav-link" href="/" Match="NavLinkMatch.All">
                        <i class="bi bi-house-door-fill"></i>
                        @if (!IsCollapsed) { <span>Inicio</span> }
                    </NavLink>
                </div>

                <div class="nav-item">
                    <NavLink class="nav-link" href="/dashboard" Match="NavLinkMatch.All">
                        <i class="bi bi-grid-1x2-fill"></i>
                        @if (!IsCollapsed) { <span>Panel Principal</span> }
                    </NavLink>
                </div>

                @* --- SECCIÓN FACTURACIÓN --- *@
                <div class="nav-section">
                    <div class="nav-link-header" @onclick="() => { if (!IsCollapsed) ToggleSubMenu(ref isFacturasOpen); }">
                        <i class="bi bi-file-earmark-text-fill"></i>
                        @if (!IsCollapsed) { <span>Facturación</span> } @* Cambié "Facturas" por "Facturación" para que abarque NC *@
                        @if (!IsCollapsed) { <i class="bi @(isFacturasOpen ? "bi-chevron-down" : "bi-chevron-right") ms-auto"></i> }
                    </div>
                    @if (isFacturasOpen || IsCollapsed)
                    {
                        <ul class="nav-submenu">
                            @* Crear Factura: Solo quien vende *@
                            <AuthorizeView Roles="Administrador, Vendedor" Context="innerContext">
                                <li><NavLink href="invoices/create"><i class="bi bi-file-earmark-plus submenu-icon"></i><span>Crear Factura</span></NavLink></li>
                            </AuthorizeView>
                            
                            @* Listar Facturas: Todos (Bodeguero necesita ver qué despachar) *@
                            <li><NavLink href="invoices" Match="NavLinkMatch.All"><i class="bi bi-card-list submenu-icon"></i><span>Listar Facturas</span></NavLink></li>
                            
                            @* Notas de Crédito: Todos (Bodeguero necesita ver devoluciones) *@
                            <li><NavLink href="credit-notes" Match="NavLinkMatch.All"><i class="bi bi-arrow-return-left submenu-icon"></i><span>Notas de Crédito</span></NavLink></li>
                            
                            @* Pagos: Solo quien cobra *@
                            <AuthorizeView Roles="Administrador, Vendedor" Context="innerContext">
                                <li><NavLink href="payments" Match="NavLinkMatch.All"><i class="bi bi-credit-card submenu-icon"></i><span>Historial de Pagos</span></NavLink></li>
                            </AuthorizeView>
                        </ul>
                    }
                </div>

                @* --- SECCIÓN CLIENTES (Solo Ventas) --- *@
                <AuthorizeView Roles="Administrador, Vendedor">
                    <div class="nav-section">
                        <div class="nav-link-header" @onclick="() => { if (!IsCollapsed) ToggleSubMenu(ref isClientesOpen); }">
                            <i class="bi bi-people-fill"></i>
                            @if (!IsCollapsed) { <span>Clientes</span> }
                            @if (!IsCollapsed) { <i class="bi @(isClientesOpen ? "bi-chevron-down" : "bi-chevron-right") ms-auto"></i> }
                        </div>
                        @if (isClientesOpen || IsCollapsed)
                        {
                            <ul class="nav-submenu">
                                <li><NavLink href="customers/create"><i class="bi bi-person-plus submenu-icon"></i><span>Crear Cliente</span></NavLink></li>
                                <li><NavLink href="customers" Match="NavLinkMatch.All"><i class="bi bi-people submenu-icon"></i><span>Listar Clientes</span></NavLink></li>
                            </ul>
                        }
                    </div>
                </AuthorizeView>

                @* --- SECCIÓN PRODUCTOS --- *@
                <div class="nav-section">
                    <div class="nav-link-header" @onclick="() => { if (!IsCollapsed) ToggleSubMenu(ref isProductosOpen); }">
                        <i class="bi bi-box-seam-fill"></i>
                        @if (!IsCollapsed) { <span>Productos</span> }
                        @if (!IsCollapsed) { <i class="bi @(isProductosOpen ? "bi-chevron-down" : "bi-chevron-right") ms-auto"></i> }
                    </div>
                    @if (isProductosOpen || IsCollapsed)
                    {
                        <ul class="nav-submenu">
                            <AuthorizeView Roles="Administrador, Bodeguero" Context="innerContext">
                                <li><NavLink href="products/create"><i class="bi bi-box-seam submenu-icon"></i><span>Crear Producto</span></NavLink></li>
                            </AuthorizeView>
                            <li><NavLink href="products" Match="NavLinkMatch.All"><i class="bi bi-boxes submenu-icon"></i><span>Listar Productos</span></NavLink></li>
                        </ul>
                    }
                </div>

                @* --- SECCIÓN BODEGA OPERATIVA (Compras e Inventario) --- *@
                <AuthorizeView Roles="Administrador, Bodeguero">
                    <div class="nav-section">
                        <div class="nav-link-header" @onclick="() => { if (!IsCollapsed) ToggleSubMenu(ref isComprasOpen); }">
                            <i class="bi bi-cart-plus-fill"></i>
                            @if (!IsCollapsed) { <span>Compras</span> }
                            @if (!IsCollapsed) { <i class="bi @(isComprasOpen ? "bi-chevron-down" : "bi-chevron-right") ms-auto"></i> }
                        </div>
                        @if (isComprasOpen || IsCollapsed)
                        {
                            <ul class="nav-submenu">
                                <li><NavLink href="purchases/create" Match="NavLinkMatch.All"><i class="bi bi-cart-plus submenu-icon"></i><span>Registrar Compra</span></NavLink></li>
                                <li><NavLink href="purchases" Match="NavLinkMatch.All"><i class="bi bi-receipt submenu-icon"></i><span>Listar Compras</span></NavLink></li>
                            </ul>
                        }
                    </div>

                    <div class="nav-section">
                        <div class="nav-link-header" @onclick="() => { if (!IsCollapsed) ToggleSubMenu(ref isInventarioOpen); }">
                            <i class="bi bi-clipboard-data-fill"></i>
                            @if (!IsCollapsed) { <span>Inventario</span> }
                            @if (!IsCollapsed) { <i class="bi @(isInventarioOpen ? "bi-chevron-down" : "bi-chevron-right") ms-auto"></i> }
                        </div>
                        @if (isInventarioOpen || IsCollapsed)
                        {
                            <ul class="nav-submenu">
                                <li><NavLink href="inventory/adjustments/create" Match="NavLinkMatch.All"><i class="bi bi-arrow-left-right submenu-icon"></i><span>Registrar Ajuste</span></NavLink></li>
                                <li><NavLink href="inventory/adjustments" Match="NavLinkMatch.All"><i class="bi bi-clipboard-data submenu-icon"></i><span>Listar Ajustes</span></NavLink></li>
                            </ul>
                        }
                    </div>
                </AuthorizeView>


                @* --- SECCIÓN REPORTES --- *@
                <AuthorizeView Roles="Administrador, Vendedor">
                    <div class="nav-section">
                        <div class="nav-link-header" @onclick="() => { if (!IsCollapsed) ToggleSubMenu(ref isReportesVentasOpen); }">
                            <i class="bi bi-graph-up"></i>
                            @if (!IsCollapsed) { <span>Reportes de Ventas</span> }
                            @if (!IsCollapsed) { <i class="bi @(isReportesVentasOpen ? "bi-chevron-down" : "bi-chevron-right") ms-auto"></i> }
                        </div>
                        @if (isReportesVentasOpen || IsCollapsed)
                        {
                            <ul class="nav-submenu">
                                <li><NavLink href="reports/sales/by-period" Match="NavLinkMatch.All"><i class="bi bi-calendar-week submenu-icon"></i><span>Ventas por Período</span></NavLink></li>
                                <li><NavLink href="reports/sales/by-product" Match="NavLinkMatch.All"><i class="bi bi-box-seam submenu-icon"></i><span>Ventas por Producto</span></NavLink></li>
                                <li><NavLink href="reports/sales/customer-activity" Match="NavLinkMatch.All"><i class="bi bi-people submenu-icon"></i><span>Actividad de Clientes</span></NavLink></li>
                                <li><NavLink href="reports/sales/accounts-receivable" Match="NavLinkMatch.All"><i class="bi bi-wallet2 submenu-icon"></i><span>Cuentas por Cobrar</span></NavLink></li>
                                <li><NavLink href="reports/sales/credit-notes" Match="NavLinkMatch.All"><i class="bi bi-arrow-return-left submenu-icon"></i><span>Notas de Crédito</span></NavLink></li>
                            </ul>
                        }
                    </div>
                </AuthorizeView>
                <AuthorizeView Roles="Administrador, Bodeguero">
                    <div class="nav-section">
                        <div class="nav-link-header" @onclick="() => { if (!IsCollapsed) ToggleSubMenu(ref isReportesBodegaOpen); }">
                            <i class="bi bi-box-seam-fill"></i>
                            @if (!IsCollapsed) { <span>Reportes de Bodega</span> }
                            @if (!IsCollapsed) { <i class="bi @(isReportesBodegaOpen ? "bi-chevron-down" : "bi-chevron-right") ms-auto"></i> }
                        </div>
                        @if (isReportesBodegaOpen || IsCollapsed)
                        {
                            <ul class="nav-submenu">
                                <li><NavLink href="reports/warehouse/current-stock" Match="NavLinkMatch.All"><i class="bi bi-boxes submenu-icon"></i><span>Stock Actual</span></NavLink></li>
                                <li><NavLink href="reports/warehouse/inventory-movements" Match="NavLinkMatch.All"><i class="bi bi-arrows-expand-vertical submenu-icon"></i><span>Movimientos de Inventario</span></NavLink></li>
                                <li><NavLink href="reports/warehouse/purchases-by-period" Match="NavLinkMatch.All"><i class="bi bi-cart-check submenu-icon"></i><span>Compras por Período</span></NavLink></li>
                                <li><NavLink href="reports/warehouse/low-stock-products" Match="NavLinkMatch.All"><i class="bi bi-exclamation-triangle submenu-icon"></i><span>Productos Bajo Stock Mínimo</span></NavLink></li>
                                <li><NavLink href="reports/warehouse/inventory-adjustments" Match="NavLinkMatch.All"><i class="bi bi-tools submenu-icon"></i><span>Ajustes de Inventario</span></NavLink></li>
                            </ul>
                        }
                    </div>
                </AuthorizeView>

                @* --- SECCIÓN ADMIN (Configuración) --- *@
                <AuthorizeView Roles="Administrador">
                    <div class="nav-section">
                        <div class="nav-link-header" @onclick="() => { if (!IsCollapsed) ToggleSubMenu(ref isImpuestosOpen); }">
                            <i class="bi bi-cash-coin"></i>
                            @if (!IsCollapsed) { <span>Impuestos</span> }
                            @if (!IsCollapsed) { <i class="bi @(isImpuestosOpen ? "bi-chevron-down" : "bi-chevron-right") ms-auto"></i> }
                        </div>
                        @if (isImpuestosOpen || IsCollapsed)
                        {
                            <ul class="nav-submenu">
                                <li><NavLink href="taxes/create"><i class="bi bi-cash-coin submenu-icon"></i><span>Crear Impuesto</span></NavLink></li>
                                <li><NavLink href="taxes" Match="NavLinkMatch.All"><i class="bi bi-calculator submenu-icon"></i><span>Listar Impuestos</span></NavLink></li>
                            </ul>
                        }
                    </div>
                    <div class="nav-section">
                        <div class="nav-link-header" @onclick="() => { if (!IsCollapsed) ToggleSubMenu(ref isUsuariosOpen); }">
                            <i class="bi bi-person-fill-gear"></i>
                            @if (!IsCollapsed) { <span>Usuarios</span> }
                            @if (!IsCollapsed) { <i class="bi @(isUsuariosOpen ? "bi-chevron-down" : "bi-chevron-right") ms-auto"></i> }
                        </div>
                        @if (isUsuariosOpen || IsCollapsed)
                        {
                            <ul class="nav-submenu">
                                <li><NavLink href="users/create"><i class="bi bi-person-add submenu-icon"></i><span>Crear Usuario</span></NavLink></li>
                                <li><NavLink href="users" Match="NavLinkMatch.All"><i class="bi bi-person-lines-fill submenu-icon"></i><span>Listar Usuarios</span></NavLink></li>
                            </ul>
                        }
                    </div>
                </AuthorizeView>
            </Authorized>
            <NotAuthorized>
                <AuthorizeView Policy="IsCustomer" Context="customerContext">
                    <Authorized>
                        <div class="nav-item">
                            <NavLink class="nav-link" href="/cliente/dashboard" Match="NavLinkMatch.All">
                                <i class="bi bi-grid-1x2-fill"></i>
                                @if (!IsCollapsed) { <span>Mi Panel</span> }
                            </NavLink>
                        </div>
                        <div class="nav-item">
                            <NavLink class="nav-link" href="/cliente/facturas">
                                <i class="bi bi-file-earmark-text-fill"></i>
                                @if (!IsCollapsed) { <span>Mis Facturas</span> }
                            </NavLink>
                        </div>
                        <div class="nav-item">
                            <NavLink class="nav-link" href="/cliente/notas-credito">
                                <i class="bi bi-arrow-return-left"></i>
                                @if (!IsCollapsed) { <span>Mis Notas de Crédito</span> }
                            </NavLink>
                        </div>
                        <div class="nav-item">
                            <NavLink class="nav-link" href="/cliente/pagos">
                                <i class="bi bi-wallet-fill"></i>
                                @if (!IsCollapsed) { <span>Mis Pagos</span> }
                            </NavLink>
                        </div>
                    </Authorized>
                    <NotAuthorized>
                        <div class="nav-item">
                            <NavLink class="nav-link" href="/login" Match="NavLinkMatch.All">
                                <i class="bi bi-box-arrow-in-right"></i>
                                @if (!IsCollapsed) { <span>Iniciar Sesión</span> }
                            </NavLink>
                        </div>
                    </NotAuthorized>
                </AuthorizeView>
            </NotAuthorized>
        </AuthorizeView>
    </nav>
</div>

@code {
    [Parameter]
    public bool IsCollapsed { get; set; }

    private bool isFacturasOpen;
    private bool isClientesOpen;
    private bool isProductosOpen;
    private bool isComprasOpen;
    private bool isImpuestosOpen;
    private bool isUsuariosOpen;
    private bool isInventarioOpen;
    private bool isReportesVentasOpen;
    private bool isReportesBodegaOpen;

    private void ToggleSubMenu(ref bool subMenuState)
    {
        subMenuState = !subMenuState;
    }
}
@page "/request-password-reset"
@layout EmptyLayout
@rendermode @(new InteractiveServerRenderMode(prerender: false))

@using System.ComponentModel.DataAnnotations
@using FacturasSRI.Application.Interfaces
@inject IUserService UserService
@inject NavigationManager Navigation

<PageTitle>Restablecer Contraseña</PageTitle>

<div class="form-container">
    <div class="card auth-card">
        <div class="card-body">
            <div class="text-center mb-4">
                <img src="logo.png" alt="Logo" style="max-width: 150px; margin-bottom: 1rem;" />
                <h1 class="h3 mb-3 fw-normal">Restablecer Contraseña</h1>
            </div>

            @if (formSubmitted)
            {
                <div class="alert alert-success">
                    <p>Si una cuenta con ese correo electrónico existe en nuestro sistema, hemos enviado un enlace para restablecer la contraseña.</p>
                    <p>Por favor, revisa tu bandeja de entrada.</p>
                </div>
                <div class="text-center mt-3">
                    <a href="/login" class="btn btn-primary">Volver a Inicio</a>
                </div>
            }
            else
            {
                <p class="text-muted text-center">Ingresa tu correo electrónico y te enviaremos un enlace para restablecer tu contraseña.</p>
                <EditForm Model="@model" OnValidSubmit="HandleRequest" FormName="requestResetForm">
                    <DataAnnotationsValidator />
                    
                    <div class="form-floating mb-3">
                        <InputText id="email" class="form-control" @bind-Value="model.Email" placeholder="correo@ejemplo.com" />
                        <label for="email">Correo Electrónico</label>
                        <ValidationMessage For="@(() => model.Email)" />
                    </div>
                    
                    <button class="w-100 btn btn-lg btn-primary" type="submit">Enviar Enlace</button>
                </EditForm>
            }
        </div>
    </div>
</div>

@code {
    private RequestModel model = new();
    private bool formSubmitted = false;

    private async Task HandleRequest()
    {
        await UserService.GeneratePasswordResetTokenAsync(model.Email);
        formSubmitted = true;
    }

    public class RequestModel
    {
        [Required(ErrorMessage = "El correo electrónico es obligatorio.")]
        [EmailAddress(ErrorMessage = "Por favor, introduce una dirección de correo válida.")]
        public string Email { get; set; } = string.Empty;
    }
}

@page "/credit-notes/edit/{Id:guid}"
@attribute [Authorize(Roles = "Administrador, Vendedor")]
@using FacturasSRI.Application.Dtos
@using FacturasSRI.Application.Interfaces
@using System.Security.Claims
@using FacturasSRI.Domain.Enums
@inject IInvoiceService InvoiceService
@inject ICreditNoteService CreditNoteService
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthenticationStateProvider

<PageTitle>Editar Borrador de Nota de Crédito</PageTitle>

<div class="container-fluid py-3">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <h1 class="h2 fw-bold mb-0 text-dark">Editar Borrador de Nota de Crédito</h1>
            <small class="text-muted">Factura Afectada: <strong>@invoiceNumber</strong></small>
        </div>
        <button type="button" class="btn btn-sm btn-light border" @onclick='() => Navigation.NavigateTo("/credit-notes")'>
            <i class="bi bi-x-lg me-1"></i>Cancelar
        </button>
    </div>

    @if (errorMessage != null)
    {
        <div class="alert alert-danger py-2 px-3 d-flex align-items-center shadow-sm mb-3 border-0 small" role="alert">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>
            <div class="flex-grow-1">@errorMessage</div>
            <button type="button" class="btn-close btn-close-white small" @onclick="() => errorMessage = null"></button>
        </div>
    }

    <EditForm Model="@formModel">
        <DataAnnotationsValidator />

        <div class="row g-3">
            <!-- COLUMNA IZQUIERDA: ITEMS -->
            <div class="col-lg-8">
                <div class="card shadow-sm border-0 rounded-3 h-100">
                    <div class="card-header bg-white border-bottom py-3">
                        <h6 class="m-0 fw-bold text-primary"><i class="bi bi-box-seam me-2"></i>Seleccione los productos a devolver</h6>
                    </div>
                    <div class="card-body p-0 d-flex flex-column">
                        
                        <div class="table-responsive flex-grow-1">
                            <table class="table table-hover table-sm table-compact align-middle mb-0">
                                <thead class="bg-white text-uppercase text-secondary border-bottom">
                                    <tr>
                                        <th class="ps-3" style="width: 40%;">Producto</th>
                                        <th class="text-center" style="width: 15%;">Disponible (Comprado)</th>
                                        <th class="text-center" style="width: 15%;">Devolver</th>
                                        <th class="text-end" style="width: 15%;">Precio</th>
                                        <th class="text-end pe-3" style="width: 15%;">Total Dev.</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @if (items == null)
                                    {
                                        <tr><td colspan="5" class="text-center py-4">Cargando detalles...</td></tr>
                                    }
                                    else
                                    {
                                        @foreach (var item in items)
                                        {
                                            <tr class="@(item.ReturnQuantity > 0 ? "bg-primary bg-opacity-10" : "")">
                                                <td class="ps-3">
                                                    <div class="fw-medium text-dark text-truncate" title="@item.ProductName">@item.ProductName</div>
                                                </td>
                                                <td class="text-center text-muted">
                                                    @item.AvailableQuantity <span class="text-body-tertiary">(@item.OriginalQuantity)</span>
                                                </td>
                                                <td class="text-center">
                                                    <InputNumber class="form-control form-control-sm text-center fw-bold border-0 p-0 shadow-none"
                                                                 @bind-Value="item.ReturnQuantity"
                                                                 @bind-Value:after="UpdateTotals"
                                                                 min="0" max="@item.AvailableQuantity"
                                                                 style="width: 60px; margin: 0 auto; background: transparent;" />
                                                </td>
                                                <td class="text-end text-muted">@item.UnitTestPrice.ToString("F2")</td>
                                                <td class="text-end pe-3 fw-bold text-dark">
                                                    @((item.ReturnQuantity * item.UnitTestPrice).ToString("F2"))
                                                </td>
                                            </tr>
                                        }
                                    }
                                </tbody>
                            </table>
                        </div>

                        <div class="bg-light bg-opacity-10 p-3 mt-auto border-top">
                            <div class="row justify-content-end">
                                <div class="col-md-7 col-lg-5">
                                    <table class="table table-borderless table-sm mb-0 small">
                                        <tbody>
                                            <tr>
                                                <td class="text-secondary text-end py-0">Subtotal:</td>
                                                <td class="text-end fw-medium py-0" style="width: 90px;">@subtotal.ToString("C")</td>
                                            </tr>
                                            <tr>
                                                <td class="text-secondary text-end py-0">IVA 15%:</td>
                                                <td class="text-end fw-medium py-0">@totalIva.ToString("C")</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                    
                                    <div class="invoice-total-row d-flex justify-content-between align-items-center border border-primary border-opacity-10 bg-white mt-2 p-2 rounded">
                                        <span class="fw-bold text-brand small text-uppercase">Total Devolución</span>
                                        <span class="fs-5 fw-bold text-brand">@total.ToString("C")</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- COLUMNA DERECHA: INFO Y ACCIONES -->
            <div class="col-lg-4 d-flex flex-column gap-3">
                
                <div class="card shadow-sm border-0 rounded-3">
                    <div class="card-body p-3">
                        <h6 class="fw-bold mb-2 small text-uppercase text-muted d-flex align-items-center">
                            <i class="bi bi-pencil-square me-2"></i> Motivo (Obligatorio)
                        </h6>
                        <InputTextArea @bind-Value="formModel.RazonModificacion" 
                                       class="form-control form-control-sm shadow-none" 
                                       rows="3" 
                                       placeholder="Ej: Devolución de mercadería por daño..." />
                        <ValidationMessage For="@(() => formModel.RazonModificacion)" class="text-danger small" />
                    </div>
                </div>

                <div class="mt-auto">
                    <div class="d-grid gap-2">
                        <button type="button" class="btn btn-primary" @onclick="() => HandleSave(false)" disabled="@(isSubmitting || total <= 0)">
                            @if(isSubmitting) { <span class="spinner-border spinner-border-sm me-2"></span> }
                            <i class="bi bi-save-fill me-2"></i>Guardar Cambios
                        </button>
                        <button type="button" class="btn btn-success" @onclick="() => HandleSave(true)" disabled="@(isSubmitting || total <= 0)">
                             @if(isSubmitting) { <span class="spinner-border spinner-border-sm me-2"></span> }
                            <i class="bi bi-send-check-fill me-2"></i>Guardar y Emitir
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </EditForm>
</div>

@code {
    [Parameter]
    public Guid Id { get; set; }

    private string? errorMessage;
    private bool isSubmitting = false;
    private string invoiceNumber = "Cargando...";

    private List<CreditNoteItemVm> items = new();
    private UpdateCreditNoteDto formModel = new();

    private decimal subtotal = 0;
    private decimal totalIva = 0;
    private decimal total = 0;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var creditNote = await CreditNoteService.GetCreditNoteDetailByIdAsync(Id);
            if (creditNote == null || creditNote.Estado != EstadoNotaDeCredito.Borrador)
            {
                errorMessage = "Borrador de nota de crédito no encontrado o en estado inválido.";
                return;
            }

            invoiceNumber = creditNote.NumeroFacturaModificada;
            formModel.Id = creditNote.Id;
            formModel.RazonModificacion = creditNote.RazonModificacion;

            var invoice = await InvoiceService.GetInvoiceDetailByIdAsync(creditNote.FacturaId);
             if (invoice == null)
            {
                errorMessage = "Factura original no encontrada.";
                return;
            }

            var ncItems = creditNote.Items.ToDictionary(i => i.ProductoId, i => i.Cantidad);

            items = invoice.Items.Select(i => new CreditNoteItemVm
            {
                ProductId = i.ProductoId,
                ProductName = i.ProductName,
                UnitTestPrice = i.PrecioVentaUnitario,
                OriginalQuantity = i.Cantidad,
                ReturnedQuantity = i.CantidadDevuelta,
                ReturnQuantity = ncItems.ContainsKey(i.ProductoId) ? ncItems[i.ProductoId] : 0,
                Taxes = i.Taxes
            }).ToList();

            UpdateTotals();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error al cargar el borrador: {ex.Message}";
        }
    }

    private void UpdateTotals()
    {
        subtotal = 0;
        totalIva = 0;

        foreach (var item in items)
        {
            if (item.ReturnQuantity < 0) item.ReturnQuantity = 0;
            if (item.ReturnQuantity > item.AvailableQuantity) item.ReturnQuantity = item.AvailableQuantity;

            if (item.ReturnQuantity > 0)
            {
                var itemSubtotal = item.ReturnQuantity * item.UnitTestPrice;
                subtotal += itemSubtotal;
                
                var hasIva = item.Taxes.Any(t => t.Porcentaje > 0);
                if (hasIva)
                {
                    var ivaRate = item.Taxes.First(t => t.Porcentaje > 0).Porcentaje;
                    totalIva += itemSubtotal * (ivaRate / 100m);
                }
            }
        }
        total = subtotal + totalIva;
    }

    private async Task HandleSave(bool emitir)
    {
        isSubmitting = true;
        errorMessage = null;

        try
        {
            if (string.IsNullOrWhiteSpace(formModel.RazonModificacion))
            {
                errorMessage = "Debe ingresar el motivo de la modificación.";
                isSubmitting = false;
                return;
            }

            var itemsToReturn = items.Where(i => i.ReturnQuantity > 0).ToList();
            if (!itemsToReturn.Any())
            {
                errorMessage = "Debe devolver al menos un producto.";
                isSubmitting = false;
                return;
            }

            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var userId = authState.User.FindFirstValue(ClaimTypes.NameIdentifier);
            if (string.IsNullOrEmpty(userId)) throw new Exception("Usuario no autenticado.");

            formModel.UsuarioIdModificador = Guid.Parse(userId);
            formModel.Items = itemsToReturn.Select(i => new CreditNoteItemDto
            {
                ProductoId = i.ProductId,
                CantidadDevolucion = i.ReturnQuantity
            }).ToList();
            formModel.EmitirTrasGuardar = emitir;

            await CreditNoteService.UpdateCreditNoteAsync(formModel);

            Navigation.NavigateTo("/credit-notes");
        }
        catch (Exception ex)
        {
            errorMessage = $"Error al guardar: {ex.Message}";
        }
        finally
        {
            isSubmitting = false;
        }
    }

    public class CreditNoteItemVm
    {
        public Guid ProductId { get; set; }
        public string ProductName { get; set; } = string.Empty;
        public decimal UnitTestPrice { get; set; }
        public int OriginalQuantity { get; set; }
        public int ReturnedQuantity { get; set; }
        public int ReturnQuantity { get; set; }
        public List<TaxDto> Taxes { get; set; } = new();
        public int AvailableQuantity => OriginalQuantity - ReturnedQuantity;
    }
}

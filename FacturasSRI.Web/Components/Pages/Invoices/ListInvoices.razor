@page "/invoices"
@attribute [Authorize(Roles = "Administrador, Vendedor, Bodeguero")]
@using FacturasSRI.Application.Dtos
@using FacturasSRI.Application.Interfaces
@using FacturasSRI.Domain.Enums
@using System.Security.Claims
@using FacturasSRI.Web.Components.Shared
@inject IInvoiceService InvoiceService
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthenticationStateProvider

<PageTitle>Facturas Emitidas</PageTitle>

<div class="d-flex justify-content-between align-items-center mb-3">
    <h1>Facturas Emitidas</h1>
    <AuthorizeView Roles="Administrador, Vendedor">
        <button class="btn btn-primary" @onclick="GoToCreateInvoice">
            <i class="bi bi-plus-circle-fill me-2"></i>Crear Nueva Factura
        </button>
    </AuthorizeView>
</div>

<div class="row g-2 mb-3">
    <div class="col-md-4">
        <input type="text" class="form-control" placeholder="Buscar por número o cliente..." 
               @bind="searchTerm" @bind:event="oninput" @onkeyup="OnFilterChanged" />
    </div>
    <div class="col-md-3">
        <InputSelect class="form-select" @bind-Value="selectedStatus" @bind-Value:after="OnFilterChanged">
            <option value="">Todos los estados de factura</option>
            @foreach (var s in Enum.GetValues(typeof(EstadoFactura)))
            {
                <option value="@s">@s.ToString()</option>
            }
        </InputSelect>
    </div>
    <div class="col-md-3">
        <InputSelect class="form-select" @bind-Value="selectedFormaDePago" @bind-Value:after="OnFilterChanged">
            <option value="">Todas las Formas de Pago</option>
            @foreach (var s in Enum.GetValues(typeof(FormaDePago)))
            {
                <option value="@s">@s.ToString()</option>
            }
        </InputSelect>
    </div>
    <div class="col-md-2">
        <InputSelect class="form-select" @bind-Value="selectedPaymentStatus" @bind-Value:after="OnFilterChanged">
            <option value="All">Todos los estados</option>
            <option value="Pending">Pendientes</option>
            <option value="Paid">Pagadas</option>
        </InputSelect>
    </div>
</div>

@if (errorMessage != null)
{
    <div class="alert alert-danger">
        <h4>Ha ocurrido un error inesperado.</h4>
        <p>Un problema ha impedido que la página se cargue correctamente. Por favor, inténtelo de nuevo, o revise su conexión a internet. Si el problema persiste, contacte a soporte técnico.</p>
    </div>
}

@if (paginatedInvoices == null && errorMessage == null)
{
    <p><em>Cargando facturas...</em></p>
}
else if(paginatedInvoices != null)
{
    <div class="table-responsive">
        <table class="table">
            <thead>
                <tr>
                    <th>Número</th>
                    <th>Cliente</th>
                    <th>Fecha</th>
                    <th>Forma Pago</th>
                    <th>Estado SRI</th>
                    <th>Vencimiento</th>
                    <th class="text-end">Saldo / Estado</th>
                    <th class="text-end">Total</th>
                    <th class="text-end">Acciones</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var invoice in paginatedInvoices.Items)
                {
                    <tr>
                        <td class="fw-bold">@invoice.NumeroFactura</td>
                        <td>@invoice.ClienteNombre</td>
                        <td>@invoice.FechaEmision.ToShortDateString()</td>
                        <td>
                            <span class="badge @(invoice.FormaDePago == FormaDePago.Credito ? "bg-info text-dark" : "bg-light text-dark border")">
                                @invoice.FormaDePago
                            </span>
                        </td>                        
                        <td>
                            @GetStatusBadge(invoice.Estado)
                        </td>
                        <td>
                            @if (invoice.FormaDePago == FormaDePago.Contado || !invoice.FechaVencimiento.HasValue)
                            {
                                <span class="text-muted small">N/A</span>
                            }
                            else
                            {
                                var diasParaVencer = (invoice.FechaVencimiento.Value - DateTime.Today).Days;
                                <span class="@(diasParaVencer <= 5 && invoice.SaldoPendiente > 0 ? "text-danger fw-bold" : "")">
                                    @invoice.FechaVencimiento.Value.ToShortDateString()
                                </span>
                            }
                        </td>
                        <td class="text-end">
                            @if (invoice.Estado != EstadoFactura.Autorizada)
                            {
                                <span class="text-muted small">No aplica</span>
                            }
                            else
                            {
                                @if (invoice.SaldoPendiente <= 0)
                                {
                                    <span class="badge bg-success">
                                        <i class="bi bi-check-circle-fill me-1"></i>Pagada
                                    </span>
                                }
                                else
                                {
                                    <span class="text-danger fw-bold">
                                        @invoice.SaldoPendiente.ToString("C")
                                    </span>
                                }
                            }
                        </td>
                        <td class="text-end fw-bold">@invoice.Total.ToString("C")</td>
                        <td class="text-end">
                            <a href="@($"invoices/{invoice.Id}")" class="btn btn-sm btn-outline-secondary" title="Ver Detalles">
                                <i class="bi bi-eye-fill"></i>
                            </a>
                            <AuthorizeView Roles="Administrador, Vendedor">
                                <div class="btn-group" role="group">
                                    @if (invoice.Estado == EstadoFactura.Borrador)
                                    {
                                        <a href="@($"invoices/edit/{invoice.Id}")" class="btn btn-sm btn-outline-primary" title="Editar Borrador">
                                            <i class="bi bi-pencil-fill"></i>
                                        </a>
                                        <button class="btn btn-sm btn-outline-danger" title="Cancelar Borrador" @onclick="() => OpenCancelModal(invoice.Id)">
                                            <i class="bi bi-x-circle-fill"></i>
                                        </button>
                                    }
                                    else if (invoice.Estado == EstadoFactura.Cancelada && userIsAdmin)
                                    {
                                        <button class="btn btn-sm btn-outline-warning" title="Reactivar Borrador" @onclick="() => ReactivateInvoice(invoice.Id)">
                                            <i class="bi bi-arrow-counterclockwise"></i>
                                        </button>
                                    }

                                    @if (invoice.Estado != EstadoFactura.Borrador && invoice.Estado != EstadoFactura.Cancelada)
                                    {
                                        @if (invoice.FormaDePago == FormaDePago.Credito
                                           && invoice.SaldoPendiente > 0
                                           && invoice.Estado == EstadoFactura.Autorizada)
                                        {
                                            <a href="@($"invoices/register-payment/{invoice.Id}")" class="btn btn-sm btn-outline-success" title="Registrar Pago">
                                                <i class="bi bi-cash-coin"></i>
                                            </a>
                                        }
                                        
                                        @* CORRECCIÓN AQUÍ: OCULTAR NC SI ES CONSUMIDOR FINAL *@
                                        @if (invoice.Estado == EstadoFactura.Autorizada && invoice.ClienteNombre != "CONSUMIDOR FINAL")
                                        {
                                             <a href="@($"credit-notes/create/{invoice.Id}")" class="btn btn-sm btn-outline-warning" title="Emitir Nota de Crédito">
                                                <i class="bi bi-arrow-return-left"></i>
                                            </a>                                       
                                        }

                                        <a href="/api/downloads/invoice-ride/@invoice.Id" target="_blank" class="btn btn-sm btn-outline-danger" title="Descargar PDF">
                                            <i class="bi bi-file-earmark-pdf"></i>
                                        </a>
                                    }
                                </div>
                            </AuthorizeView>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <div class="d-flex justify-content-between align-items-center mt-3">
        @if (paginatedInvoices.TotalCount > 0)
        {
            <p class="text-muted mb-0 small">
                Mostrando del @((currentPage - 1) * pageSize + 1) al @Math.Min(currentPage * pageSize, paginatedInvoices.TotalCount) de @paginatedInvoices.TotalCount registros.
            </p>
            <Pagination CurrentPage="currentPage" 
                        TotalPages="paginatedInvoices.TotalPages" 
                        OnPageSelected="SelectedPage" />
        }
        else
        {
            <p class="text-muted mb-0 small">No se encontraron registros.</p>
        }
    </div>
}
                        
@if (showCancelModal)
{
    <div class="modal fade show d-block" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirmar Cancelación</h5>
                    <button type="button" class="btn-close" @onclick="CloseCancelModal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>¿Está seguro de que desea cancelar este borrador?</p>
                    <p class="text-muted small">Esta acción no se puede deshacer directamente, pero un administrador podrá reactivar la factura si es necesario.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseCancelModal">Cerrar</button>
                    <button type="button" class="btn btn-danger" @onclick="ConfirmCancelInvoice">Sí, Cancelar</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-backdrop fade show"></div>
}

@code {

    private PaginatedList<InvoiceDto>? paginatedInvoices;

    private string? errorMessage;

    private int currentPage = 1;

    private int pageSize = 15; // Coincide con la propuesta



    private string searchTerm = string.Empty;

    private EstadoFactura? selectedStatus;

    private FormaDePago? selectedFormaDePago;

    private string selectedPaymentStatus = "All";



    private bool userIsAdmin = false;



        protected override async Task OnInitializedAsync()



        {



            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();



            var user = authState.User;



            userIsAdmin = user.IsInRole("Administrador");



    



            await LoadInvoices(1);



        }



    



        private async Task LoadInvoices(int pageNumber)



        {



            currentPage = pageNumber;



            try



            {



                paginatedInvoices = await InvoiceService.GetInvoicesAsync(currentPage, pageSize, searchTerm, selectedStatus, selectedFormaDePago, selectedPaymentStatus);



                StateHasChanged(); // Forzar actualización de la UI



            }



            catch (Exception)



            {



                errorMessage = "Error al cargar facturas.";



            }



        }



    



        private async Task OnFilterChanged()



        {



            await LoadInvoices(1);



        }



    



        private async Task SelectedPage(int page)



        {



            await LoadInvoices(page);



        }



    private void GoToCreateInvoice()

    {

        Navigation.NavigateTo("/invoices/create");

    }

    

    // ... (El resto de los métodos como CancelInvoice, etc. se mantienen)

    // Se eliminará FilteredInvoices y se modificará la tabla para usar paginatedInvoices.Items

    

    private async Task CancelInvoice(Guid invoiceId)

    {

        try

        {

            await InvoiceService.CancelInvoiceAsync(invoiceId);

            await LoadInvoices(currentPage); // Recargar la página actual

        }

        catch (Exception ex)

        {

            errorMessage = $"Error al cancelar la factura: {ex.Message}";

        }

    }



    private bool showCancelModal = false;

    private Guid? invoiceToCancelId;



    private void OpenCancelModal(Guid invoiceId)

    {

        invoiceToCancelId = invoiceId;

        showCancelModal = true;

    }



    private void CloseCancelModal()

    {

        invoiceToCancelId = null;

        showCancelModal = false;

    }



    private async Task ConfirmCancelInvoice()

    {

        if (invoiceToCancelId.HasValue)

        {

            await CancelInvoice(invoiceToCancelId.Value);

        }

        CloseCancelModal();

    }

    

    private async Task ReactivateInvoice(Guid invoiceId)

    {

        try

        {

            await InvoiceService.ReactivateCancelledInvoiceAsync(invoiceId);

            await LoadInvoices(currentPage); // Recargar la página actual

        }

        catch (Exception ex)

        {

            errorMessage = $"Error al reactivar la factura: {ex.Message}";

        }

    }



    private RenderFragment GetStatusBadge(EstadoFactura estado)

    {

        return builder =>

        {

            var (badgeClass, iconClass, text) = estado switch

            {

                EstadoFactura.Autorizada => ("bg-success", "bi-check-circle-fill", "Autorizada"),

                EstadoFactura.EnviadaSRI => ("bg-info text-dark", "bi-send", "Enviada SRI"),

                EstadoFactura.Borrador => ("bg-warning text-dark", "bi-pencil-square", "Borrador"),

                EstadoFactura.Cancelada => ("bg-secondary", "bi-x-octagon-fill", "Cancelada"),

                _ => ("bg-danger", "bi-x-circle-fill", estado.ToString())

            };



            builder.OpenElement(0, "span");

            builder.AddAttribute(1, "class", $"badge {badgeClass}");

            

            builder.OpenElement(2, "i");

            builder.AddAttribute(3, "class", $"bi {iconClass} me-1");

            builder.CloseElement();

            

            builder.AddContent(4, text);

            builder.CloseElement();

        };

    }

}
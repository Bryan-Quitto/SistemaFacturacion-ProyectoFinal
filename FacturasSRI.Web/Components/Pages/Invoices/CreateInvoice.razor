@page "/invoices/create"
@attribute [Authorize]
@using FacturasSRI.Application.Dtos
@using FacturasSRI.Application.Interfaces
@using System.ComponentModel.DataAnnotations
@inject IInvoiceService InvoiceService
@inject ICustomerService CustomerService
@inject IProductService ProductService
@inject NavigationManager Navigation
@using System.Security.Claims
@inject AuthenticationStateProvider AuthenticationStateProvider
@using FacturasSRI.Domain.Enums

<PageTitle>Crear Nueva Factura</PageTitle>

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="page-header mb-4">
                <h1 class="page-title">Crear Nueva Factura</h1>
                <p class="text-muted">Emite una nueva factura electrónica de forma rápida y sencilla.</p>
            </div>
        </div>
    </div>

    @if (errorMessage != null)
    {
        <div class="alert alert-danger" role="alert">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>
            @errorMessage
        </div>
    }

    <EditForm Model="@formModel" OnValidSubmit="@HandleCreateInvoice">
        <DataAnnotationsValidator />

        <div class="row">
            <div class="col-lg-8">
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="card-title mb-0"><i class="bi bi-box-seam me-2"></i>Productos de la Factura</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Buscar Producto</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-search"></i></span>
                                <input type="text" class="form-control" placeholder="Escriba para buscar producto por nombre o código..." 
                                       @bind="productSearchTerm" @bind:event="oninput" @onkeyup="SearchProducts" disabled="@(customerSelectionType == "existing" && !formModel.SelectedClienteId.HasValue)"/>
                            </div>
                             @if (productSearchResults.Any())
                            {
                                <ul class="list-group position-absolute w-100" style="z-index: 1000;">
                                    @foreach (var product in productSearchResults)
                                    {
                                        <li class="list-group-item list-group-item-action" @onclick="() => AddItem(product)">
                                            @product.Nombre (@product.CodigoPrincipal) - <strong>@product.PrecioVentaUnitario.ToString("C")</strong>
                                        </li>
                                    }
                                </ul>
                            }
                        </div>

                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>Producto</th>
                                        <th style="width: 120px;">Cantidad</th>
                                        <th class="text-end">Precio Unit.</th>
                                        <th class="text-end">Subtotal</th>
                                        <th class="text-center">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @if (!invoiceItems.Any())
                                    {
                                        <tr>
                                            <td colspan="5" class="text-center text-muted py-4">
                                                <i class="bi bi-cart-x" style="font-size: 2rem;"></i>
                                                <p class="mb-0">Aún no has añadido productos.</p>
                                            </td>
                                        </tr>
                                    }
                                    @foreach (var item in invoiceItems)
                                    {
                                        <tr>
                                            <td>
                                                <strong>@item.ProductName</strong><br/>
                                                <small class="text-muted">@string.Join(", ", item.Taxes.Select(t => t.Nombre))</small>
                                            </td>
                                            <td>
                                                <InputNumber class="form-control form-control-sm" 
                                                             @bind-Value="item.Cantidad"
                                                             @bind-Value:after="UpdateTotals" 
                                                             min="1" />
                                                <ValidationMessage For="@(() => item.Cantidad)" />
                                            </td>
                                            <td class="text-end">@item.PrecioVentaUnitario.ToString("C")</td>
                                            <td class="text-end">@((item.Cantidad * item.PrecioVentaUnitario).ToString("C"))</td>
                                            <td class="text-center">
                                                <button type="button" class="btn btn-sm btn-outline-danger" @onclick="() => RemoveItem(item.ProductoId)">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="card-title mb-0"><i class="bi bi-person-circle me-2"></i>Información del Cliente</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Tipo de Cliente</label>
                            <InputRadioGroup @bind-Value="customerSelectionType" @bind-Value:after="OnCustomerSelectionTypeChanged">
                                <div class="form-check form-check-inline">
                                    <InputRadio Value="@("existing")" id="radioExistingCustomer" class="form-check-input" />
                                    <label class="form-check-label" for="radioExistingCustomer">Cliente Existente</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <InputRadio Value="@("finalConsumer")" id="radioFinalConsumer" class="form-check-input" />
                                    <label class="form-check-label" for="radioFinalConsumer">Consumidor Final</label>
                                </div>
                            </InputRadioGroup>
                        </div>

                        @if (customerSelectionType == "existing")
                        {
                            <div class="mb-3">
                                <label class="form-label">Buscar Cliente</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                                    <input type="text" class="form-control" placeholder="Nombre o RUC..." 
                                           @bind="customerSearchTerm" @bind:event="oninput" @onkeyup="SearchCustomers" />
                                </div>
                                @if (customerSearchResults.Any())
                                {
                                    <ul class="list-group position-absolute w-100" style="z-index: 1000;">
                                        @foreach (var customer in customerSearchResults)
                                        {
                                            <li class="list-group-item list-group-item-action" @onclick="() => SelectCustomer(customer)">
                                                @customer.RazonSocial (@customer.NumeroIdentificacion)
                                            </li>
                                        }
                                    </ul>
                                }
                            </div>

                            @if (formModel.SelectedClienteId.HasValue)
                            {
                                <div class="alert alert-info">
                                    <strong>@selectedCustomer?.RazonSocial</strong><br/>
                                    <i class="bi bi-card-text"></i> @selectedCustomer?.NumeroIdentificacion<br/>
                                    <i class="bi bi-envelope"></i> @selectedCustomer?.Email
                                    <button type="button" class="btn btn-sm btn-outline-danger float-end" @onclick="ClearCustomer">
                                        <i class="bi bi-x"></i>
                                    </button>
                                </div>
                            }
                            else
                            {
                                <div class="alert alert-warning">
                                    <i class="bi bi-exclamation-circle me-2"></i>
                                    Por favor, selecciona un cliente.
                                </div>
                            }
                        }
                        else if (customerSelectionType == "finalConsumer")
                        {
                            <div class="alert alert-info">
                                <i class="bi bi-person-fill me-2"></i>
                                Facturando a Consumidor Final.
                            </div>
                        }
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0"><i class="bi bi-receipt-cutoff me-2"></i>Resumen de la Factura</h5>
                    </div>
                    <div class="card-body">
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                Subtotal
                                <span>@subtotal.ToString("C")</span>
                            </li>
                            @foreach (var taxSummary in taxSummaries)
                            {
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    @taxSummary.TaxName (@taxSummary.TaxRate.ToString("0.##")%)
                                    <span>@taxSummary.Amount.ToString("C")</span>
                                </li>
                            }
                            <li class="list-group-item d-flex justify-content-between align-items-center fs-5 fw-bold bg-light">
                                Total
                                <span>@total.ToString("C")</span>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-12 d-flex justify-content-end">
                <button type="button" class="btn btn-secondary me-2" @onclick='() => Navigation.NavigateTo("/invoices")'>
                    <i class="bi bi-x-circle me-2"></i>Cancelar
                </button>
                <button type="submit" class="btn btn-primary" disabled="@(!invoiceItems.Any() || isSubmitting || (customerSelectionType == "existing" && !formModel.SelectedClienteId.HasValue))">
                     @if (isSubmitting)
                    {
                        <span class="spinner-border spinner-border-sm me-2" aria-hidden="true"></span>
                        <span>Generando...</span>
                    }
                    else
                    {
                        <i class="bi bi-check-circle-fill me-2"></i>
                        <span>Generar Factura</span>
                    }
                </button>
            </div>
        </div>
    </EditForm>
</div>

@code {
    private string? errorMessage;
    private bool isSubmitting = false;

    private List<CustomerDto> allCustomers = new();
    private List<ProductDto> allProducts = new();

    private string customerSearchTerm = string.Empty;
    private List<CustomerDto> customerSearchResults = new();
    private CustomerDto? selectedCustomer;

    private string productSearchTerm = string.Empty;
    private List<ProductDto> productSearchResults = new();

    private List<InvoiceItemViewModel> invoiceItems = new();
    private CreateInvoiceFormModel formModel = new();
    private string customerSelectionType = "existing";
    
    private decimal subtotal = 0;
    private decimal total = 0;
    private List<TaxSummary> taxSummaries = new();

    protected override async Task OnInitializedAsync()
    {
        try
        {
            allCustomers = await CustomerService.GetActiveCustomersAsync();
            allProducts = await ProductService.GetProductsAsync();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error al cargar datos iniciales: {ex.Message}";
        }
    }

    private void SearchCustomers()
    {
        if (customerSelectionType != "existing" || string.IsNullOrWhiteSpace(customerSearchTerm))
        {
            customerSearchResults.Clear();
            return;
        }
        customerSearchResults = allCustomers
            .Where(c => c.RazonSocial.Contains(customerSearchTerm, StringComparison.OrdinalIgnoreCase) || 
                        c.NumeroIdentificacion.Contains(customerSearchTerm, StringComparison.OrdinalIgnoreCase))
            .Take(5)
            .ToList();
    }

    private void SelectCustomer(CustomerDto customer)
    {
        selectedCustomer = customer;
        formModel.SelectedClienteId = customer.Id;
        customerSearchTerm = string.Empty;
        customerSearchResults.Clear();
    }
    
    private void ClearCustomer()
    {
        selectedCustomer = null;
        formModel.SelectedClienteId = null;
    }

    private void OnCustomerSelectionTypeChanged()
    {
        selectedCustomer = null;
        formModel.SelectedClienteId = null;
        customerSearchTerm = string.Empty;
        customerSearchResults.Clear();
    }

    private void SearchProducts()
    {
        if (string.IsNullOrWhiteSpace(productSearchTerm))
        {
            productSearchResults.Clear();
            return;
        }
        productSearchResults = allProducts
            .Where(p => p.Nombre.Contains(productSearchTerm, StringComparison.OrdinalIgnoreCase) || 
                        p.CodigoPrincipal.Contains(productSearchTerm, StringComparison.OrdinalIgnoreCase))
            .Take(5)
            .ToList();
    }

    private async Task AddItem(ProductDto product)
    {
        var existingItem = invoiceItems.FirstOrDefault(i => i.ProductoId == product.Id);
        if (existingItem != null)
        {
            existingItem.Cantidad++;
        }
        else
        {
            var productDetails = await ProductService.GetProductDetailsByIdAsync(product.Id);
            if (productDetails != null)
            {
                invoiceItems.Add(new InvoiceItemViewModel
                {
                    ProductoId = productDetails.Id,
                    ProductName = productDetails.Nombre,
                    Cantidad = 1,
                    PrecioVentaUnitario = productDetails.PrecioVentaUnitario,
                    Taxes = productDetails.Taxes
                });
            }
        }
        
        productSearchTerm = string.Empty;
        productSearchResults.Clear();
        UpdateTotals();
    }
    
    private void RemoveItem(Guid productId)
    {
        var item = invoiceItems.FirstOrDefault(i => i.ProductoId == productId);
        if (item != null)
        {
            invoiceItems.Remove(item);
            UpdateTotals();
        }
    }

    private void UpdateTotals()
    {
        subtotal = invoiceItems.Sum(i => i.Cantidad * i.PrecioVentaUnitario);
        
        taxSummaries = invoiceItems
            .SelectMany(item => item.Taxes.Select(tax => new {
                item.Cantidad,
                item.PrecioVentaUnitario,
                TaxName = tax.Nombre,
                TaxRate = tax.Porcentaje
            }))
            .GroupBy(t => new { t.TaxName, t.TaxRate })
            .Select(g => new TaxSummary {
                TaxName = g.Key.TaxName,
                TaxRate = g.Key.TaxRate,
                Amount = g.Sum(x => x.Cantidad * x.PrecioVentaUnitario * (x.TaxRate / 100))
            })
            .ToList();

        total = subtotal + taxSummaries.Sum(ts => ts.Amount);
        StateHasChanged();
    }

    private async Task HandleCreateInvoice()
    {
        isSubmitting = true;
        errorMessage = null;

        if (!invoiceItems.Any())
        {
            errorMessage = "Debe añadir al menos un producto.";
            isSubmitting = false;
            return;
        }

        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        var userId = user.FindFirstValue(ClaimTypes.NameIdentifier);

        if (string.IsNullOrEmpty(userId))
        {
            errorMessage = "No se pudo identificar al usuario. Por favor, inicie sesión de nuevo.";
            isSubmitting = false;
            return;
        }

        CreateInvoiceDto createDto = new CreateInvoiceDto
        {
            UsuarioIdCreador = Guid.Parse(userId),
            Items = invoiceItems.Select(i => new InvoiceItemDto
            {
                ProductoId = i.ProductoId,
                Cantidad = i.Cantidad
            }).ToList()
        };

        if (customerSelectionType == "existing")
        {
            if (!formModel.SelectedClienteId.HasValue)
            {
                errorMessage = "Debe seleccionar un cliente existente.";
                isSubmitting = false;
                return;
            }
            createDto.ClienteId = formModel.SelectedClienteId.Value;
        }
        else if (customerSelectionType == "finalConsumer")
        {
            createDto.TipoIdentificacionComprador = TipoIdentificacion.ConsumidorFinal;
        }
        else
        {
            errorMessage = "Debe seleccionar un tipo de cliente.";
            isSubmitting = false;
            return;
        }

        try
        {
            await InvoiceService.CreateInvoiceAsync(createDto);
            Navigation.NavigateTo("/invoices");
        }
        catch (InvalidOperationException stockEx)
        {
            errorMessage = stockEx.Message;
        }
        catch (ArgumentException argEx)
        {
            errorMessage = argEx.Message;
        }
        catch (Exception ex)
        {
            errorMessage = $"Error inesperado al generar la factura: {ex.Message}";
        }
        finally
        {
            isSubmitting = false;
        }
    }

    public class InvoiceItemViewModel
    {
        public Guid ProductoId { get; set; }
        public string ProductName { get; set; } = string.Empty;
        
        [Range(1, int.MaxValue, ErrorMessage = "La cantidad debe ser al menos 1.")]
        public int Cantidad { get; set; }
        
        public decimal PrecioVentaUnitario { get; set; }
        public List<TaxDto> Taxes { get; set; } = new();
    }

    public class TaxSummary
    {
        public string TaxName { get; set; } = string.Empty;
        public decimal TaxRate { get; set; }
        public decimal Amount { get; set; }
    }

    public class CreateInvoiceFormModel
    {
        public Guid? SelectedClienteId { get; set; }
    }
}
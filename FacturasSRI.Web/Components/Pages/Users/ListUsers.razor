@page "/users"
@attribute [Authorize(Roles = "Administrador")]
@using System.Security.Claims
@using FacturasSRI.Application.Dtos
@using FacturasSRI.Application.Interfaces
@using FacturasSRI.Web.Components.Shared
@inject IUserService UserService
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthenticationStateProvider

<PageTitle>Lista de Usuarios</PageTitle>

<div class="d-flex justify-content-between align-items-center mb-3">
    <div>
        <h1>Gestión de Usuarios</h1>
        <p class="text-muted mb-0">Edita y administra los usuarios del sistema.</p>
    </div>
    <button class="btn btn-primary" @onclick="GoToCreateUser">
        <i class="bi bi-plus-circle-fill me-2"></i>Nuevo Usuario
    </button>
</div>

<div class="mb-3">
    <input type="text" class="form-control" placeholder="Buscar usuarios por nombre o correo..." @bind-value="searchTerm" @bind-value:event="oninput" />
</div>

@if (!string.IsNullOrEmpty(statusMessage))
{
    <div class="alert @(isSuccess ? "alert-success" : "alert-danger") mb-4 shadow-sm border-0" role="alert">
        <i class="bi @(isSuccess ? "bi-check-circle-fill" : "bi-exclamation-triangle-fill") me-2"></i> @statusMessage
        <button type="button" class="btn-close float-end" @onclick="ClearStatusMessage" aria-label="Close"></button>
    </div>
}

<div class="table-responsive">
    <table class="table table-hover align-middle">
        <thead>
            <tr>
                <th>Nombre Completo</th>
                <th>Correo Electrónico</th>
                <th>Roles</th>
                <th>Estado</th>
                <th class="text-end">Acciones</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var user in FilteredUsers)
            {
                <tr>
                    <td class="fw-medium">
                        <div class="d-flex align-items-center">
                            <div class="bg-light rounded-circle p-2 me-2 text-primary d-flex align-items-center justify-content-center" style="width: 32px; height: 32px;">
                                <i class="bi bi-person-fill"></i>
                            </div>
                            @user.PrimerNombre @user.SegundoNombre @user.PrimerApellido @user.SegundoApellido
                        </div>
                    </td>
                    <td>@user.Email</td>
                    <td>
                        @foreach(var role in user.Roles)
                        {
                            <span class="badge bg-light text-dark border me-1">@role</span>
                        }
                    </td>
                    <td>
                        @if (user.EstaActivo)
                        {
                            <span class="badge bg-success">Activo</span>
                        }
                        else
                        {
                            <span class="badge bg-secondary">Inactivo</span>
                        }
                    </td>
                    <td class="text-end">
                        <div class="btn-group shadow-sm" role="group">
                            @if (currentUserId == user.Id)
                            {
                                <a href="/profile" class="btn btn-sm btn-outline-secondary" title="Mi Perfil">
                                    <i class="bi bi-person-badge-fill"></i>
                                </a>
                            }
                            else
                            {
                                <a href="@($"/users/edit/{user.Id}")" class="btn btn-sm btn-outline-primary @(user.EstaActivo ? "" : "disabled")"
                                   title="@(user.EstaActivo ? "Editar" : "No se puede editar inactivo")">
                                    <i class="bi bi-pencil-fill"></i>
                                </a>
                            }
                            
                            @if (currentUserId != user.Id)
                            {
                                <button class="btn btn-sm @(user.EstaActivo ? "btn-outline-danger" : "btn-outline-success")" 
                                        @onclick="() => HandleToggleUserStatus(user.Id)"
                                        title="@(user.EstaActivo ? "Desactivar" : "Activar")">
                                    <i class="bi @(user.EstaActivo ? "bi-trash-fill" : "bi-check-circle-fill")"></i>
                                </button>
                            }
                        </div>
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>

<ConfirmationModal IsVisible="showConfirmationModal"
                   Title="@confirmationModalTitle"
                   Message="@confirmationModalMessage"
                   OnConfirm="ConfirmToggleUserStatus"
                   OnCancel="CancelToggleUserStatus" />

@code {
    private List<UserDto> allUsers = new();
    private Guid currentUserId;
    private bool showConfirmationModal = false;
    private string confirmationModalTitle = string.Empty;
    private string confirmationModalMessage = string.Empty;
    private Guid userToToggleId;
    private string? statusMessage;
    private bool isSuccess;
    private string searchTerm = string.Empty;

    private List<UserDto> FilteredUsers => string.IsNullOrWhiteSpace(searchTerm)
        ? allUsers
        : allUsers.Where(u => (u.PrimerNombre != null && u.PrimerNombre.Contains(searchTerm, StringComparison.OrdinalIgnoreCase)) ||
                               (u.PrimerApellido != null && u.PrimerApellido.Contains(searchTerm, StringComparison.OrdinalIgnoreCase)) ||
                               (u.Email != null && u.Email.Contains(searchTerm, StringComparison.OrdinalIgnoreCase)))
                      .ToList();

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        if (user.Identity != null && user.Identity.IsAuthenticated)
        {
            var userIdClaim = user.FindFirst(ClaimTypes.NameIdentifier);
            if (userIdClaim != null && Guid.TryParse(userIdClaim.Value, out var id))
            {
                currentUserId = id;
            }
        }
        await LoadData();
    }

    private async Task LoadData()
    {
        allUsers = await UserService.GetUsersAsync();
    }

    private void HandleToggleUserStatus(Guid id)
    {
        var userToToggle = allUsers.FirstOrDefault(u => u.Id == id);
        if (userToToggle == null) return;

        userToToggleId = id;
        confirmationModalTitle = "Confirmar Acción";
        confirmationModalMessage = $"¿Está seguro de que desea {(userToToggle.EstaActivo ? "desactivar" : "activar")} al usuario {userToToggle.PrimerNombre} {userToToggle.PrimerApellido}?";
        showConfirmationModal = true;
    }

    private async Task ConfirmToggleUserStatus()
    {
        showConfirmationModal = false;
        var userToToggle = allUsers.FirstOrDefault(u => u.Id == userToToggleId);
        if (userToToggle == null) return;

        try
        {
            await UserService.DeleteUserAsync(userToToggleId);
            isSuccess = true;
            statusMessage = $"El estado del usuario '{userToToggle.PrimerNombre} {userToToggle.PrimerApellido}' ha sido cambiado correctamente.";
            await LoadData();
        }
        catch (Exception ex)
        {
            isSuccess = false;
            statusMessage = $"Error: {ex.Message}";
        }
    }

    private void CancelToggleUserStatus()
    {
        showConfirmationModal = false;
        userToToggleId = Guid.Empty;
    }

    private void ClearStatusMessage()
    {
        statusMessage = null;
        StateHasChanged();
    }

    private void GoToCreateUser()
    {
        Navigation.NavigateTo("/users/create");
    }
}
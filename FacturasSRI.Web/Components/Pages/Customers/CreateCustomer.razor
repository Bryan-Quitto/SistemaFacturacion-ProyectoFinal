@page "/customers/create"
@attribute [Authorize(Roles = "Administrador, Vendedor")]
@using FacturasSRI.Application.Dtos
@using FacturasSRI.Application.Interfaces
@using FacturasSRI.Domain.Enums
@inject ICustomerService CustomerService
@inject NavigationManager Navigation
@using System.Security.Claims
@inject AuthenticationStateProvider AuthenticationStateProvider

<PageTitle>Crear Cliente</PageTitle>

<h3>Crear Nuevo Cliente</h3>

<div class="card">
    <div class="card-body">
        <EditForm Model="@newCustomer" OnValidSubmit="@HandleAddCustomer">
            <DataAnnotationsValidator />
            
            @if (!string.IsNullOrEmpty(statusMessage))
            {
                <div class="alert @(isSuccess ? "alert-success" : "alert-danger") mb-4">
                    @statusMessage
                    <button type="button" class="btn-close float-end" @onclick="ClearStatusMessage" aria-label="Close"></button>
                </div>
            }

            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="razonSocial" class="form-label">Razón Social</label>
                        <InputText id="razonSocial" class="form-control" @bind-Value="newCustomer.RazonSocial" />
                        <ValidationMessage For="@(() => newCustomer.RazonSocial)" />
                    </div>
                    <div class="mb-3">
                        <label for="tipoIdentificacion" class="form-label">Tipo de Identificación</label>
                        <InputSelect id="tipoIdentificacion" class="form-select" @bind-Value="newCustomer.TipoIdentificacion">
                            @foreach (var tipo in Enum.GetValues(typeof(TipoIdentificacion)))
                            {
                                <option value="@tipo">@tipo</option>
                            }
                        </InputSelect>
                    </div>
                    <div class="mb-3">
                        <label for="numeroIdentificacion" class="form-label">Número de Identificación</label>
                        <InputText id="numeroIdentificacion" class="form-control" @bind-Value="newCustomer.NumeroIdentificacion" />
                        <ValidationMessage For="@(() => newCustomer.NumeroIdentificacion)" />
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="email" class="form-label">Correo Electrónico</label>
                        <InputText id="email" class="form-control" @bind-Value="newCustomer.Email" />
                        <ValidationMessage For="@(() => newCustomer.Email)" />
                    </div>
                    <div class="mb-3">
                        <label for="direccion" class="form-label">Dirección</label>
                        <InputText id="direccion" class="form-control" @bind-Value="newCustomer.Direccion" />
                        <ValidationMessage For="@(() => newCustomer.Direccion)" />
                    </div>
                    <div class="mb-3">
                        <label for="telefono" class="form-label">Teléfono</label>
                        <InputText id="telefono" class="form-control" @bind-Value="newCustomer.Telefono" />
                        <ValidationMessage For="@(() => newCustomer.Telefono)" />
                    </div>
                </div>
            </div>
            <div class="mt-3">
                <button type="button" class="btn btn-secondary" @onclick="GoToList">Cancelar</button>
                <button type="submit" class="btn btn-primary">Guardar Cliente</button>
            </div>
        </EditForm>
    </div>
</div>

@code {
    private CustomerDto newCustomer = new();
    private string? statusMessage;
    private bool isSuccess;

    private async Task HandleAddCustomer()
    {
        // 1. VALIDACIÓN NUEVA: IMPEDIR "CONSUMIDOR FINAL"
        if (!string.IsNullOrWhiteSpace(newCustomer.RazonSocial) && 
            string.Equals(newCustomer.RazonSocial.Trim(), "CONSUMIDOR FINAL", StringComparison.OrdinalIgnoreCase))
        {
            isSuccess = false;
            statusMessage = "Error: No puede crear un cliente manualmente con la Razón Social 'CONSUMIDOR FINAL'. Este es un registro reservado del sistema.";
            StateHasChanged();
            return;
        }

        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        var userId = user.FindFirstValue(ClaimTypes.NameIdentifier);

        if (string.IsNullOrEmpty(userId))
        {
            isSuccess = false;
            statusMessage = "No se pudo identificar al usuario. Por favor, inicie sesión de nuevo.";
            StateHasChanged();
            return;
        }

        newCustomer.UsuarioIdCreador = Guid.Parse(userId);

        try
        {
            await CustomerService.CreateCustomerAsync(newCustomer);
            Navigation.NavigateTo("/customers");
        }
        catch (InvalidOperationException ex)
        {
            isSuccess = false;
            statusMessage = ex.Message;
            StateHasChanged();
        }
        catch (Exception)
        {
            isSuccess = false;
            statusMessage = "Ocurrió un error inesperado al guardar el cliente. Por favor, revise los datos e inténtelo de nuevo. Si el problema persiste, contacte a soporte técnico.";
            StateHasChanged();
        }
    }

    private void GoToList()
    {
        Navigation.NavigateTo("/customers");
    }

    private void ClearStatusMessage()
    {
        statusMessage = null;
        isSuccess = false;
        StateHasChanged();
    }
}
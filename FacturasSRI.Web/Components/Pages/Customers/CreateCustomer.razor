@page "/customers/create"
@attribute [Authorize(Policy = "VendedorPolicy")]
@using FacturasSRI.Application.Dtos
@using FacturasSRI.Application.Interfaces
@inject ICustomerService CustomerService
@inject NavigationManager Navigation
@using System.Security.Claims
@inject AuthenticationStateProvider AuthenticationStateProvider

<PageTitle>Crear Cliente</PageTitle>

<h3>Crear Nuevo Cliente</h3>

<div class="card">
    <div class="card-body">
        <EditForm Model="@newCustomer" OnValidSubmit="@HandleAddCustomer">
            <DataAnnotationsValidator />
            
            @if (!string.IsNullOrEmpty(statusMessage))
            {
                <div class="alert @(isSuccess ? "alert-success" : "alert-danger")">@statusMessage</div>
            }

            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="razonSocial" class="form-label">Razón Social</label>
                        <InputText id="razonSocial" class="form-control" @bind-Value="newCustomer.RazonSocial" />
                        <ValidationMessage For="@(() => newCustomer.RazonSocial)" />
                    </div>
                    <div class="mb-3">
                        <label for="numeroIdentificacion" class="form-label">Número de Identificación</label>
                        <InputText id="numeroIdentificacion" class="form-control" @bind-Value="newCustomer.NumeroIdentificacion" />
                        <ValidationMessage For="@(() => newCustomer.NumeroIdentificacion)" />
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="email" class="form-label">Correo Electrónico</label>
                        <InputText id="email" class="form-control" @bind-Value="newCustomer.Email" />
                        <ValidationMessage For="@(() => newCustomer.Email)" />
                    </div>
                    <div class="mb-3">
                        <label for="direccion" class="form-label">Dirección</label>
                        <InputText id="direccion" class="form-control" @bind-Value="newCustomer.Direccion" />
                        <ValidationMessage For="@(() => newCustomer.Direccion)" />
                    </div>
                    <div class="mb-3">
                        <label for="telefono" class="form-label">Teléfono</label>
                        <InputText id="telefono" class="form-control" @bind-Value="newCustomer.Telefono" />
                        <ValidationMessage For="@(() => newCustomer.Telefono)" />
                    </div>
                </div>
            </div>
            <div class="mt-3">
                <button type="button" class="btn btn-secondary" @onclick="GoToList">Cancelar</button>
                <button type="submit" class="btn btn-primary">Guardar Cliente</button>
            </div>
        </EditForm>
    </div>
</div>

@code {
    private CustomerDto newCustomer = new();
    private string? statusMessage;
    private bool isSuccess;

    private async Task HandleAddCustomer()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        var userId = user.FindFirstValue(ClaimTypes.NameIdentifier);

        if (string.IsNullOrEmpty(userId))
        {
            isSuccess = false;
            statusMessage = "No se pudo identificar al usuario. Por favor, inicie sesión de nuevo.";
            return;
        }

        newCustomer.UsuarioIdCreador = Guid.Parse(userId);

        try
        {
            await CustomerService.CreateCustomerAsync(newCustomer);
            Navigation.NavigateTo("/customers");
        }
        catch (Exception)
        {
            isSuccess = false;
            statusMessage = "Error al guardar el cliente. Por favor, intente de nuevo.";
        }
    }

    private void GoToList()
    {
        Navigation.NavigateTo("/customers");
    }
}
@page "/customers"
@attribute [Authorize(Roles = "Administrador, Vendedor")]
@using FacturasSRI.Application.Dtos
@using FacturasSRI.Application.Interfaces
@using FacturasSRI.Web.Components.Shared
@using Microsoft.AspNetCore.Components.Authorization
@inject ICustomerService CustomerService
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IUserService UserService

<PageTitle>Lista de Clientes</PageTitle>

<div class="d-flex justify-content-between align-items-center mb-3">
    <div>
        <h1>Clientes</h1>
        <p class="text-muted mb-0">Administra tu cartera de clientes.</p>
    </div>
    <button class="btn btn-primary" @onclick="GoToCreateCustomer">
        <i class="bi bi-plus-circle-fill me-2"></i>Nuevo Cliente
    </button>
</div>

<div class="mb-3">
    <input type="text" class="form-control" placeholder="Buscar clientes por razón social o identificación..." @bind-value="searchTerm" @bind-value:event="oninput" />
</div>

@if (!string.IsNullOrEmpty(statusMessage))
{
    <div class="alert @(isSuccess ? "alert-success" : "alert-danger") mb-4 shadow-sm border-0" role="alert">
        <i class="bi @(isSuccess ? "bi-check-circle-fill" : "bi-exclamation-triangle-fill") me-2"></i> @statusMessage
        <button type="button" class="btn-close float-end" @onclick="ClearStatusMessage" aria-label="Close"></button>
    </div>
}

<div class="table-responsive">
    <table class="table table-hover align-middle">
        <thead>
            <tr>
                <th>Razón Social</th>
                <th>Identificación</th>
                <th>Contacto</th>
                <th>Creado por</th>
                <th>Estado</th>
                <th class="text-end">Acciones</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var customer in FilteredCustomers)
            {
                <tr>
                    <td class="fw-medium">@customer.RazonSocial</td>
                    <td>
                        <div class="d-flex flex-column">
                            <span class="text-muted small">@customer.TipoIdentificacion</span>
                            <span>@customer.NumeroIdentificacion</span>
                        </div>
                    </td>
                    <td>
                        <div class="d-flex flex-column small">
                            @if (!string.IsNullOrEmpty(customer.Email))
                            {
                                <div><i class="bi bi-envelope me-1 text-muted"></i>@customer.Email</div>
                            }
                            @if (!string.IsNullOrEmpty(customer.Telefono))
                            {
                                <div><i class="bi bi-telephone me-1 text-muted"></i>@customer.Telefono</div>
                            }
                        </div>
                    </td>
                    <td class="small text-muted">@customer.CreadoPor</td>
                    <td>
                        @if (customer.EstaActivo)
                        {
                            <span class="badge bg-success">Activo</span>
                        }
                        else
                        {
                            <span class="badge bg-secondary">Inactivo</span>
                        }
                    </td>
                    <td class="text-end">
                        <div class="btn-group shadow-sm" role="group">
                            <a href="@($"/customers/edit/{customer.Id}")" class="btn btn-sm btn-outline-primary" title="Editar">
                                <i class="bi bi-pencil-fill"></i>
                            </a>
                            <button class="btn btn-sm @(customer.EstaActivo ? "btn-outline-danger" : "btn-outline-success")" 
                                    @onclick="() => HandleDeleteCustomer(customer.Id)"
                                    title="@(customer.EstaActivo ? "Desactivar" : "Activar")">
                                <i class="bi @(customer.EstaActivo ? "bi-trash-fill" : "bi-check-circle-fill")"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>

<ConfirmationModal IsVisible="showConfirmationModal"
                   Title="@confirmationModalTitle"
                   Message="@confirmationModalMessage"
                   OnConfirm="ConfirmToggleCustomerStatus"
                   OnCancel="CancelToggleCustomerStatus" />

@code {
    private List<CustomerDto> allCustomers = new();
    private bool showConfirmationModal = false;
    private string confirmationModalTitle = string.Empty;
    private string confirmationModalMessage = string.Empty;
    private Guid customerToToggleId;
    private string? statusMessage;
    private bool isSuccess;
    private string searchTerm = string.Empty;

    private List<CustomerDto> FilteredCustomers => string.IsNullOrWhiteSpace(searchTerm)
        ? allCustomers
        : allCustomers.Where(c => c.RazonSocial.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
                                  c.NumeroIdentificacion.Contains(searchTerm, StringComparison.OrdinalIgnoreCase))
                      .ToList();

    protected override async Task OnInitializedAsync()
    {
        await LoadCustomers();
    }
    
    private async Task LoadCustomers()
    {
        allCustomers = await CustomerService.GetCustomersAsync();
    }

    private void HandleDeleteCustomer(Guid id)
    {
        var customerToToggle = allCustomers.FirstOrDefault(c => c.Id == id);
        if (customerToToggle == null) return;

        customerToToggleId = id;
        confirmationModalTitle = "Confirmar Acción";
        confirmationModalMessage = $"¿Está seguro de que desea {(customerToToggle.EstaActivo ? "desactivar" : "activar")} al cliente {customerToToggle.RazonSocial}?";
        showConfirmationModal = true;
    }

    private async Task ConfirmToggleCustomerStatus()
    {
        showConfirmationModal = false;
        var customerToToggle = allCustomers.FirstOrDefault(c => c.Id == customerToToggleId);
        if (customerToToggle == null) return;

        try
        {
            await CustomerService.DeleteCustomerAsync(customerToToggleId);
            isSuccess = true;
            statusMessage = $"El cliente '{customerToToggle.RazonSocial}' ha sido {(customerToToggle.EstaActivo ? "desactivado" : "activado")} correctamente.";
            await LoadCustomers();
        }
        catch (Exception ex)
        {
            isSuccess = false;
            statusMessage = $"Error: {ex.Message}";
        }
    }

    private void CancelToggleCustomerStatus()
    {
        showConfirmationModal = false;
        customerToToggleId = Guid.Empty;
    }

    private void ClearStatusMessage()
    {
        statusMessage = null;
        StateHasChanged();
    }

    private void GoToCreateCustomer()
    {
        Navigation.NavigateTo("/customers/create");
    }
}
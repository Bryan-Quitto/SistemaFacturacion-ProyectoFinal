@page "/customers"
@attribute [Authorize(Roles = "Administrador, Vendedor")]
@using FacturasSRI.Application.Dtos
@using FacturasSRI.Application.Interfaces
@using FacturasSRI.Web.Components.Shared
@using Microsoft.AspNetCore.Components.Authorization
@inject ICustomerService CustomerService
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IUserService UserService

<PageTitle>Lista de Clientes</PageTitle>

<div class="d-flex justify-content-between align-items-center mb-3">
    <div>
        <h1>Clientes</h1>
        <p class="text-muted mb-0">Administra tu cartera de clientes.</p>
    </div>
    <button class="btn btn-primary" @onclick="GoToCreateCustomer">
        <i class="bi bi-plus-circle-fill me-2"></i>Nuevo Cliente
    </button>
</div>

@if (errorMessage != null)
{
    <div class="alert alert-danger">@errorMessage</div>
}

<div class="mb-3">
    <input type="text" class="form-control" placeholder="Buscar clientes por razón social, identificación, email o teléfono..." 
           @bind="searchTerm" @bind:event="oninput" @onkeyup="OnFilterChanged" />
</div>

@if (!string.IsNullOrEmpty(statusMessage))
{
    <div class="alert @(isSuccess ? "alert-success" : "alert-danger") mb-4 shadow-sm border-0" role="alert">
        <i class="bi @(isSuccess ? "bi-check-circle-fill" : "bi-exclamation-triangle-fill") me-2"></i> @statusMessage
        <button type="button" class="btn-close float-end" @onclick="ClearStatusMessage" aria-label="Close"></button>
    </div>
}

@if (paginatedCustomers == null && errorMessage == null)
{
    <p><em>Cargando clientes...</em></p>
}
else if (paginatedCustomers != null)
{
    <div class="table-responsive">
        <table class="table table-hover align-middle">
            <thead>
                <tr>
                    <th>Razón Social</th>
                    <th>Identificación</th>
                    <th>Contacto</th>
                    <th>Creado por</th>
                    <th>Estado</th>
                    <th class="text-end">Acciones</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var customer in paginatedCustomers.Items)
                {
                    <tr>
                        <td class="fw-medium">@customer.RazonSocial</td>
                        <td>
                            <div class="d-flex flex-column">
                                <span class="text-muted small">@customer.TipoIdentificacion</span>
                                <span>@customer.NumeroIdentificacion</span>
                            </div>
                        </td>
                        <td>
                            <div class="d-flex flex-column small">
                                @if (!string.IsNullOrEmpty(customer.Email))
                                {
                                    <div><i class="bi bi-envelope me-1 text-muted"></i>@customer.Email</div>
                                }
                                @if (!string.IsNullOrEmpty(customer.Telefono))
                                {
                                    <div><i class="bi bi-telephone me-1 text-muted"></i>@customer.Telefono</div>
                                }
                            </div>
                        </td>
                        <td class="small text-muted">@customer.CreadoPor</td>
                        <td>
                            @if (customer.EstaActivo)
                            {
                                <span class="badge bg-success">Activo</span>
                            }
                            else
                            {
                                <span class="badge bg-secondary">Inactivo</span>
                            }
                        </td>
                        <td class="text-end">
                            <div class="btn-group shadow-sm" role="group">
                                <a href="@($"/customers/edit/{customer.Id}")" class="btn btn-sm btn-outline-primary" title="Editar">
                                    <i class="bi bi-pencil-fill"></i>
                                </a>
                                <button class="btn btn-sm @(customer.EstaActivo ? "btn-outline-danger" : "btn-outline-success")" 
                                        @onclick="() => HandleDeleteCustomer(customer.Id)"
                                        title="@(customer.EstaActivo ? "Desactivar" : "Activar")">
                                    <i class="bi @(customer.EstaActivo ? "bi-trash-fill" : "bi-check-circle-fill")"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <div class="d-flex justify-content-between align-items-center mt-3">
        @if (paginatedCustomers.TotalCount > 0)
        {
            <p class="text-muted mb-0 small">
                Mostrando del @((currentPage - 1) * pageSize + 1) al @Math.Min(currentPage * pageSize, paginatedCustomers.TotalCount) de @paginatedCustomers.TotalCount registros.
            </p>
            <Pagination CurrentPage="currentPage" 
                        TotalPages="paginatedCustomers.TotalPages" 
                        OnPageSelected="SelectedPage" />
        }
        else
        {
            <p class="text-muted mb-0 small">No se encontraron clientes con los filtros seleccionados.</p>
        }
    </div>
}

<ConfirmationModal IsVisible="showConfirmationModal"
                   Title="@confirmationModalTitle"
                   Message="@confirmationModalMessage"
                   OnConfirm="ConfirmToggleCustomerStatus"
                   OnCancel="CancelToggleCustomerStatus" />

@code {
    private PaginatedList<CustomerDto>? paginatedCustomers;
    private bool showConfirmationModal = false;
    private string confirmationModalTitle = string.Empty;
    private string confirmationModalMessage = string.Empty;
    private Guid customerToToggleId;
    private string? statusMessage;
    private string? errorMessage;
    private bool isSuccess;
    
    // Paginación y Filtros
    private int currentPage = 1;
    private int pageSize = 15;
    private string searchTerm = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await LoadCustomers(currentPage);
    }
    
    private async Task LoadCustomers(int page)
    {
        currentPage = page;
        errorMessage = null;
        try
        {
            paginatedCustomers = await CustomerService.GetCustomersAsync(currentPage, pageSize, searchTerm);
            StateHasChanged();
        }
        catch (Exception)
        {
            errorMessage = "Error al cargar clientes.";
        }
    }

    private async Task OnFilterChanged()
    {
        await LoadCustomers(1);
    }
    
    private async Task SelectedPage(int page)
    {
        await LoadCustomers(page);
    }

    private void HandleDeleteCustomer(Guid id)
    {
        var customerToToggle = paginatedCustomers?.Items.FirstOrDefault(c => c.Id == id);
        if (customerToToggle == null) return;

        customerToToggleId = id;
        confirmationModalTitle = "Confirmar Acción";
        confirmationModalMessage = $"¿Está seguro de que desea {(customerToToggle.EstaActivo ? "desactivar" : "activar")} al cliente {customerToToggle.RazonSocial}?";
        showConfirmationModal = true;
    }

    private async Task ConfirmToggleCustomerStatus()
    {
        showConfirmationModal = false;
        var customerToToggle = paginatedCustomers?.Items.FirstOrDefault(c => c.Id == customerToToggleId);
        if (customerToToggle == null) return;

        try
        {
            await CustomerService.DeleteCustomerAsync(customerToToggleId);
            isSuccess = true;
            statusMessage = $"El cliente '{customerToToggle.RazonSocial}' ha sido {(customerToToggle.EstaActivo ? "desactivado" : "activado")} correctamente.";
            await LoadCustomers(currentPage); // Recargar la página actual
        }
        catch (Exception ex)
        {
            isSuccess = false;
            statusMessage = $"Error: {ex.Message}";
        }
    }

    private void CancelToggleCustomerStatus()
    {
        showConfirmationModal = false;
        customerToToggleId = Guid.Empty;
    }

    private void ClearStatusMessage()
    {
        statusMessage = null;
        StateHasChanged();
    }

    private void GoToCreateCustomer()
    {
        Navigation.NavigateTo("/customers/create");
    }
}
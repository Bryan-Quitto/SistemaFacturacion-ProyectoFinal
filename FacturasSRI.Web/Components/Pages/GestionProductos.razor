@page "/gestion-productos"
@inject HttpClient Http
@inject NavigationManager Navigation
@inject CurrentUserState CurrentUser
@using FacturasSRI.Application.Dtos.Productos
@using FacturasSRI.Application.Dtos.Inventario
@using System.Net.Http.Headers
@implements IDisposable

<div class="d-flex justify-content-between align-items-center mb-3">
    <h3>Gestión de Productos</h3>
    <button class="btn btn-primary" @onclick="GoToCreatePage">
        <span class="bi bi-plus-circle-fill me-2" aria-hidden="true"></span> Crear Nuevo Producto
    </button>
</div>

<div class="input-group mb-3">
    <span class="input-group-text">
        <span class="bi bi-search"></span>
    </span>
    <input type="text" class="form-control" placeholder="Buscar por código o nombre..." 
           @bind="searchQuery" @bind:event="oninput" />
</div>

@if (editingId.HasValue && productoModel != null)
{
    <div class="card shadow-sm mb-4">
        <div class="card-header">
            Editando Producto
        </div>
        <div class="card-body">
            <EditForm Model="@productoModel" OnValidSubmit="HandleUpdate" FormName="edit-product-form">
                <DataAnnotationsValidator />
                <div class="mb-3">
                    <label class="form-label">Nombre</label>
                    <InputText class="form-control" @bind-Value="productoModel.Nombre" />
                </div>
                <div class="mb-3">
                    <label class="form-label">Descripción</label>
                    <InputTextArea class="form-control" @bind-Value="productoModel.Descripcion" />
                </div>
                 <div class="mb-3">
                    <label class="form-label">Precio de Venta</label>
                    <InputNumber class="form-control" @bind-Value="productoModel.PrecioVentaUnitario" />
                </div>
                <button type="submit" class="btn btn-primary">Actualizar</button>
                <button type="button" class="btn btn-secondary" @onclick="CancelEdit">Cancelar</button>
            </EditForm>
        </div>
    </div>
}

@if (isLoading)
{
    <p><em>Cargando productos...</em></p>
}
else if (productos == null)
{
    <div class="alert alert-danger">Error al cargar productos.</div>
}
else
{
    <table class="table table-striped table-hover shadow-sm">
        <thead class="table-dark">
            <tr>
                <th>Código</th>
                <th>Nombre</th>
                <th>Precio</th>
                <th>Estado</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var producto in FilteredProducts)
            {
                <tr>
                    <td>@producto.CodigoPrincipal</td>
                    <td>@producto.Nombre</td>
                    <td>@producto.PrecioVentaUnitario.ToString("C")</td>
                    <td>
                        <span class="badge @(producto.EstaActivo ? "bg-success" : "bg-danger")">
                            @(producto.EstaActivo ? "Activo" : "Inactivo")
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" @onclick="() => StartEdit(producto)">Editar</button>
                        <button class="btn btn-sm btn-outline-info" @onclick="() => ShowStockModal(producto)">Ver Stock</button>
                        @if (producto.EstaActivo)
                        {
                            <button class="btn btn-sm btn-outline-danger" @onclick="() => Deactivate(producto.Id)">Desactivar</button>
                        }
                        else
                        {
                            <button class="btn btn-sm btn-outline-success" @onclick="() => Activate(producto.Id)">Activar</button>
                        }
                    </td>
                </tr>
            }
        </tbody>
    </table>
}

@if (isStockModalVisible)
{
    <div class="modal fade show" tabindex="-1" style="display: block;" role="dialog">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Stock de: @selectedProductName</h5>
                    <button type="button" class="btn-close" @onclick="CloseStockModal"></button>
                </div>
                <div class="modal-body">
                    @if (isLoadingStock)
                    {
                        <p>Cargando stock...</p>
                    }
                    else if (lotesStock == null || !lotesStock.Any())
                    {
                        <p>No hay lotes registrados para este producto.</p>
                    }
                    else
                    {
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Fecha Compra</th>
                                    <th>Fecha Caducidad</th>
                                    <th>Precio Compra</th>
                                    <th>Comprada</th>
                                    <th>Disponible</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var lote in lotesStock)
                                {
                                    <tr>
                                        <td>@lote.FechaCompra.ToShortDateString()</td>
                                        <td>@(lote.FechaCaducidad?.ToShortDateString() ?? "N/A")</td>
                                        <td>@lote.PrecioCompraUnitario.ToString("C")</td>
                                        <td>@lote.CantidadComprada</td>
                                        <td><strong>@lote.CantidadDisponible</strong></td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    }
                </div>
            </div>
        </div>
    </div>
    <div class="modal-backdrop fade show"></div>
}


@code {
    private List<ProductoDto>? productos;
    private string searchQuery = string.Empty;
    private Guid? editingId;
    private UpdateProductoDto? productoModel;
    private bool isLoading = true;
    private bool hasAttemptedLoad = false;
    
    // Estado del Modal de Stock (HU-08)
    private bool isStockModalVisible = false;
    private bool isLoadingStock = false;
    private string selectedProductName = "";
    private List<LoteDto>? lotesStock;

    private IEnumerable<ProductoDto> FilteredProducts =>
        productos?.Where(p =>
            string.IsNullOrWhiteSpace(searchQuery) ||
            p.CodigoPrincipal.Contains(searchQuery, StringComparison.OrdinalIgnoreCase) ||
            p.Nombre.Contains(searchQuery, StringComparison.OrdinalIgnoreCase)
        ) ?? Enumerable.Empty<ProductoDto>();

    protected override void OnInitialized()
    {
        CurrentUser.OnChange += HandleAuthStateChanged;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await LoadDataIfAuthenticated();
        }
    }

    private async void HandleAuthStateChanged()
    {
        await LoadDataIfAuthenticated();
    }

    private async Task LoadDataIfAuthenticated()
    {
        if (CurrentUser.IsLoggedIn && !hasAttemptedLoad)
        {
            hasAttemptedLoad = true;
            Http.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("Bearer", CurrentUser.Token);
            await LoadProducts();
            StateHasChanged();
        }
    }

    private async Task LoadProducts()
    {
        isLoading = true;
        try
        {
            productos = await Http.GetFromJsonAsync<List<ProductoDto>>("api/productos");
        }
        catch (Exception)
        {
            productos = null;
        }
        isLoading = false;
    }

    private void StartEdit(ProductoDto producto) 
    {
        editingId = producto.Id;
        productoModel = new UpdateProductoDto 
        { 
            Nombre = producto.Nombre, 
            Descripcion = producto.Descripcion, 
            PrecioVentaUnitario = producto.PrecioVentaUnitario 
        };
    }
    
    private async Task HandleUpdate()
    {
        if (editingId.HasValue && productoModel != null)
        {
            await Http.PutAsJsonAsync($"api/productos/{editingId.Value}", productoModel);
            CancelEdit();
            await LoadProducts();
        }
    }
    
    private void CancelEdit()
    {
        editingId = null;
        productoModel = null;
    }
    
    private async Task Deactivate(Guid id)
    {
        await Http.PatchAsync($"api/productos/{id}/deactivate", null);
        await LoadProducts();
    }
    
    private async Task Activate(Guid id)
    {
        await Http.PatchAsync($"api/productos/{id}/activate", null);
        await LoadProducts();
    }

    private void GoToCreatePage()
    {
        Navigation.NavigateTo("/gestion-productos/crear");
    }

    // Métodos para el Modal de Stock (HU-08)
    private async Task ShowStockModal(ProductoDto producto)
    {
        selectedProductName = producto.Nombre;
        isStockModalVisible = true;
        isLoadingStock = true;
        lotesStock = null;

        try
        {
            lotesStock = await Http.GetFromJsonAsync<List<LoteDto>>($"api/productos/{producto.Id}/stock");
        }
        catch (Exception)
        {
            lotesStock = null;
        }
        isLoadingStock = false;
        StateHasChanged();
    }

    private void CloseStockModal()
    {
        isStockModalVisible = false;
        lotesStock = null;
        selectedProductName = "";
    }

    public void Dispose()
    {
        CurrentUser.OnChange -= HandleAuthStateChanged;
    }
}
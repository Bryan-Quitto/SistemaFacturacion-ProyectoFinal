@page "/products"
@attribute [Authorize(Roles = "Administrador, Vendedor, Bodeguero")]
@using FacturasSRI.Application.Dtos
@using FacturasSRI.Application.Interfaces
@using FacturasSRI.Web.Components.Shared
@inject IProductService ProductService
@inject ITaxService TaxService
@inject NavigationManager Navigation

<PageTitle>Lista de Productos</PageTitle>

<div class="d-flex justify-content-between align-items-center mb-3">
    <div>
        <h1>Gestión de Productos</h1>
        <p class="text-muted mb-0">Edita y administra tus productos existentes.</p>
    </div>
    <div class="d-flex align-items-center gap-3">
        <div class="text-end d-none d-md-block">
            <span class="text-muted small d-block">Impuesto Global</span>
            <span class="badge bg-light text-dark border">@(currentGlobalTax?.Nombre ?? "No asignado")</span>
        </div>
        <AuthorizeView Roles="Administrador, Bodeguero">
            <div class="btn-group shadow-sm">
                <button class="btn btn-outline-secondary" @onclick="OpenGlobalTaxModal" title="Cambiar Impuesto Global">
                    <i class="bi bi-gear-fill"></i>
                </button>
                <button class="btn btn-primary" @onclick="GoToCreateProduct">
                    <i class="bi bi-plus-circle-fill me-2"></i>Nuevo Producto
                </button>
            </div>
        </AuthorizeView>
    </div>
</div>

<div class="row mb-3">
    <div class="col-12">
        <input type="text" class="form-control" placeholder="Buscar productos por nombre o código..."
            @bind-value="searchTerm" @bind-value:event="oninput" />
    </div>
</div>

@if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="alert alert-danger mb-4 shadow-sm border-0" role="alert">
        <i class="bi bi-exclamation-triangle-fill me-2"></i> @errorMessage
    </div>
}

@if (allProducts == null)
{
    <p><em>Cargando productos...</em></p>
}
else
{
    <div class="table-responsive">
        <table class="table table-hover align-middle">
            <thead>
                <tr>
                    <th>Nombre</th>
                    <th>Código</th>
                    <th>Marca</th>
                    <th>Categoría</th>
                    <th>Precio</th>
                    <th>Stock</th>
                    <th>Estado</th>
                    <th class="text-end">Acciones</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var product in FilteredProducts)
                {
                    <tr>
                        <td class="fw-medium">@product.Nombre</td>
                        <td><span class="text-muted small">@product.CodigoPrincipal</span></td>
                        <td>@product.Marca</td>
                        <td>@product.CategoriaNombre</td>
                        <td class="fw-bold">@product.PrecioVentaUnitario.ToString("C")</td>
                        <td>
                            <span class="@(product.StockTotal <= 5 ? "text-danger fw-bold" : "")">
                                @product.StockTotal
                            </span>
                        </td>
                        <td>
                            @if (product.IsActive)
                            {
                                <span class="badge bg-success">Activo</span>
                            }
                            else
                            {
                                <span class="badge bg-secondary">Inactivo</span>
                            }
                        </td>
                        <td class="text-end">
                            <div class="btn-group shadow-sm" role="group">
                                <a href="@($"/products/details/{product.Id}")" class="btn btn-sm btn-outline-secondary" title="Ver Detalles">
                                    <i class="bi bi-eye-fill"></i>
                                </a>
                                <AuthorizeView Roles="Administrador, Bodeguero">
                                    <a href="@($"/products/edit/{product.Id}")" class="btn btn-sm btn-outline-primary" title="Editar">
                                        <i class="bi bi-pencil-fill"></i>
                                    </a>
                                    <button class="btn btn-sm @(product.IsActive ? "btn-outline-danger" : "btn-outline-success")"
                                            @onclick="() => HandleDeleteProduct(product.Id)"
                                            title="@(product.IsActive ? "Desactivar" : "Activar")">
                                        <i class="bi @(product.IsActive ? "bi-trash-fill" : "bi-check-circle-fill")"></i>
                                    </button>
                                </AuthorizeView>
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
}

<ConfirmationModal IsVisible="showConfirmationModal" Title="@confirmationModalTitle" Message="@confirmationModalMessage"
    OnConfirm="ConfirmToggleProductStatus" OnCancel="CancelToggleProductStatus" />

@if (isGlobalTaxModalVisible)
{
    <div class="modal fade show" style="display:block" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Administrar Impuesto Global</h5>
                    <button type="button" class="btn-close" @onclick="CloseGlobalTaxModal"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted small">Seleccione un impuesto para aplicarlo a todos los productos. Esto reemplazará cualquier impuesto asignado previamente.</p>
                    <div class="mb-3">
                        <label for="globalTax" class="form-label fw-bold">Impuesto</label>
                        <InputSelect id="globalTax" class="form-select" @bind-Value="selectedTaxId">
                            <option value="@Guid.Empty">-- Seleccione un impuesto --</option>
                            @foreach (var tax in allTaxes)
                            {
                                <option value="@tax.Id">@tax.Nombre (@tax.Porcentaje%)</option>
                            }
                        </InputSelect>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseGlobalTaxModal">Cancelar</button>
                    <button type="button" class="btn btn-primary" @onclick="ApplyGlobalTax"
                        disabled="@(selectedTaxId == Guid.Empty)">
                        <i class="bi bi-arrow-repeat me-2"></i>Aplicar a Todos
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-backdrop fade show"></div>
}

@code {
    private List<ProductDto>? allProducts;
    private string? errorMessage;

    private bool showConfirmationModal = false;
    private string confirmationModalTitle = string.Empty;
    private string confirmationModalMessage = string.Empty;
    private Guid productToToggleId;

    private string searchTerm = string.Empty;

    private Guid selectedTaxId;
    private List<TaxDto> allTaxes = new();
    private TaxDto? currentGlobalTax;
    private bool isGlobalTaxModalVisible = false;

    private List<ProductDto> FilteredProducts => (allProducts ?? new())
    .Where(p => (string.IsNullOrWhiteSpace(searchTerm) ||
    p.Nombre.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
    p.CodigoPrincipal.Contains(searchTerm, StringComparison.OrdinalIgnoreCase)))
    .ToList();

    protected override async Task OnInitializedAsync()
    {
        await LoadProducts();
        await LoadTaxes();
        await LoadCurrentGlobalTax();
    }

    private async Task LoadTaxes()
    {
        try
        {
            allTaxes = await TaxService.GetActiveTaxesAsync();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error cargando impuestos: {ex.Message}";
        }
    }

    private async Task LoadCurrentGlobalTax()
    {
        try
        {
            currentGlobalTax = await ProductService.GetCurrentGlobalTaxAsync();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error cargando impuesto global: {ex.Message}";
        }
    }

    private void OpenGlobalTaxModal()
    {
        isGlobalTaxModalVisible = true;
    }

    private void CloseGlobalTaxModal()
    {
        isGlobalTaxModalVisible = false;
    }

    private async Task ApplyGlobalTax()
    {
        if (selectedTaxId == Guid.Empty)
        {
            errorMessage = "Por favor, seleccione un impuesto para aplicar.";
            return;
        }

        errorMessage = null;
        try
        {
            await ProductService.ApplyTaxToAllProductsAsync(selectedTaxId);
            CloseGlobalTaxModal();
            await LoadCurrentGlobalTax();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error al aplicar impuesto global: {ex.Message}";
        }
    }

    private async Task LoadProducts()
    {
        errorMessage = null;
        try
        {
            allProducts = await ProductService.GetProductsAsync();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error cargando productos: {ex.Message}";
        }
    }

    private void HandleDeleteProduct(Guid id)
    {
        var productToToggle = allProducts?.FirstOrDefault(p => p.Id == id);
        if (productToToggle == null) return;

        productToToggleId = id;
        confirmationModalTitle = "Confirmar Acción";
        confirmationModalMessage = $"¿Está seguro de que desea {(productToToggle.IsActive ? "desactivar" : "activar")} el producto {productToToggle.Nombre}?";
        showConfirmationModal = true;
    }

    private async Task ConfirmToggleProductStatus()
    {
        errorMessage = null;
        showConfirmationModal = false;

        var productToToggle = allProducts?.FirstOrDefault(p => p.Id == productToToggleId);
        if (productToToggle == null) return;

        string action = productToToggle.IsActive ? "desactivar" : "activar";

        try
        {
            await ProductService.DeleteProductAsync(productToToggleId);
            await LoadProducts();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error al {action} el producto: {ex.Message}";
        }
    }

    private void CancelToggleProductStatus()
    {
        showConfirmationModal = false;
        productToToggleId = Guid.Empty;
    }

    private void GoToCreateProduct()
    {
        Navigation.NavigateTo("/products/create");
    }
}
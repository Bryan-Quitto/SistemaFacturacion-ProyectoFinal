@page "/products"
@attribute [Authorize(Roles = "Administrador, Vendedor, Bodeguero")]
@using FacturasSRI.Application.Dtos
@using FacturasSRI.Application.Interfaces
@using FacturasSRI.Web.Components.Shared
@inject IProductService ProductService
@inject ITaxService TaxService
@inject NavigationManager Navigation

<PageTitle>Lista de Productos</PageTitle>

<div class="d-flex justify-content-between align-items-center mb-3">
    <div>
        <h1>Gestión de Productos</h1>
        <p class="text-muted mb-0">Edita y administra tus productos existentes.</p>
    </div>
    <div class="d-flex align-items-center gap-3">
        <div class="text-end d-none d-md-block">
            <span class="text-muted small d-block">Impuesto Global</span>
            <span class="badge bg-light text-dark border">@(currentGlobalTax?.Nombre ?? "No asignado")</span>
        </div>
        <AuthorizeView Roles="Administrador, Bodeguero">
            <div class="btn-group shadow-sm">
                <button class="btn btn-outline-secondary" @onclick="OpenGlobalTaxModal" title="Cambiar Impuesto Global">
                    <i class="bi bi-gear-fill"></i>
                </button>
                <button class="btn btn-primary" @onclick="GoToCreateProduct">
                    <i class="bi bi-plus-circle-fill me-2"></i>Nuevo Producto
                </button>
            </div>
        </AuthorizeView>
    </div>
</div>

<div class="card border-0 shadow-sm mb-4">
    <div class="card-body">
        <div class="row g-2">
            <div class="col-md-4">
                <input type="text" class="form-control" placeholder="Buscar productos por nombre o código..."
                       @bind="searchTerm" @bind:event="oninput" @onkeyup="OnFilterChanged" />
            </div>
            <div class="col-md-2">
                <InputSelect class="form-select" @bind-Value="selectedCategoryId" @bind-Value:after="OnFilterChanged">
                    <option value="">Categoría</option>
                    @foreach (var cat in allCategorias)
                    {
                        <option value="@cat.Id">@cat.Nombre</option>
                    }
                </InputSelect>
            </div>
            <div class="col-md-2">
                <InputSelect class="form-select" @bind-Value="selectedMarca" @bind-Value:after="OnFilterChanged">
                    <option value="">Marca</option>
                    @foreach (var marca in allMarcas)
                    {
                        <option value="@marca">@marca</option>
                    }
                </InputSelect>
            </div>
            <div class="col-md-2">
                <InputSelect class="form-select" @bind-Value="selectedStockStatus" @bind-Value:after="OnFilterChanged">
                    <option value="All">Stock (Todos)</option>
                    <option value="InStock">Con Stock</option>
                    <option value="OutOfStock">Sin Stock</option>
                </InputSelect>
            </div>
        </div>
    </div>
</div>

@if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="alert alert-danger">@errorMessage</div>
}

@if (paginatedProducts == null && string.IsNullOrEmpty(errorMessage))
{
    <p><em>Cargando productos...</em></p>
}
else if (paginatedProducts != null)
{
    <div class="table-responsive">
        <table class="table table-hover align-middle">
            <thead>
                <tr>
                    <th>Nombre</th>
                    <th>Código</th>
                    <th>Marca</th>
                    <th>Categoría</th>
                    <th>Precio</th>
                    <th>Stock</th>
                    <th>Estado</th>
                    <th class="text-end">Acciones</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var product in paginatedProducts.Items)
                {
                    <tr>
                        <td class="fw-medium">@product.Nombre</td>
                        <td><span class="text-muted small">@product.CodigoPrincipal</span></td>
                        <td>@product.Marca</td>
                        <td>@product.CategoriaNombre</td>
                        <td class="fw-bold">@product.PrecioVentaUnitario.ToString("C")</td>
                        <td>
                            <span class="@(product.ManejaInventario && product.StockTotal <= 5 ? "text-danger fw-bold" : "")">
                                @(product.ManejaInventario ? product.StockTotal.ToString() : "N/A")
                            </span>
                        </td>
                        <td>
                            @if (product.IsActive)
                            {
                                <span class="badge bg-success">Activo</span>
                            }
                            else
                            {
                                <span class="badge bg-secondary">Inactivo</span>
                            }
                        </td>
                        <td class="text-end">
                            <div class="btn-group shadow-sm" role="group">
                                <a href="@($"/products/details/{product.Id}")" class="btn btn-sm btn-outline-secondary" title="Ver Detalles">
                                    <i class="bi bi-eye-fill"></i>
                                </a>
                                <AuthorizeView Roles="Administrador, Bodeguero">
                                    <a href="@($"/products/edit/{product.Id}")" class="btn btn-sm btn-outline-primary" title="Editar">
                                        <i class="bi bi-pencil-fill"></i>
                                    </a>
                                    <button class="btn btn-sm @(product.IsActive ? "btn-outline-danger" : "btn-outline-success")"
                                            @onclick="() => HandleDeleteProduct(product.Id)"
                                            title="@(product.IsActive ? "Desactivar" : "Activar")">
                                        <i class="bi @(product.IsActive ? "bi-trash-fill" : "bi-check-circle-fill")"></i>
                                    </button>
                                </AuthorizeView>
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <div class="d-flex justify-content-between align-items-center mt-3">
        @if (paginatedProducts.TotalCount > 0)
        {
            <p class="text-muted mb-0 small">
                Mostrando del @((currentPage - 1) * pageSize + 1) al @Math.Min(currentPage * pageSize, paginatedProducts.TotalCount) de @paginatedProducts.TotalCount registros.
            </p>
            <Pagination CurrentPage="currentPage" 
                        TotalPages="paginatedProducts.TotalPages" 
                        OnPageSelected="SelectedPage" />
        }
        else
        {
            <p class="text-muted mb-0 small">No se encontraron productos con los filtros seleccionados.</p>
        }
    </div>
}

<ConfirmationModal IsVisible="showConfirmationModal" Title="@confirmationModalTitle" Message="@confirmationModalMessage"
    OnConfirm="ConfirmToggleProductStatus" OnCancel="CancelToggleProductStatus" />

@if (isGlobalTaxModalVisible)
{
    <div class="modal fade show" style="display:block" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Administrar Impuesto Global</h5>
                    <button type="button" class="btn-close" @onclick="CloseGlobalTaxModal"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted small">Seleccione un impuesto para aplicarlo a todos los productos. Esto reemplazará cualquier impuesto asignado previamente.</p>
                    <div class="mb-3">
                        <label for="globalTax" class="form-label fw-bold">Impuesto</label>
                        <InputSelect id="globalTax" class="form-select" @bind-Value="selectedTaxId">
                            <option value="@Guid.Empty">-- Seleccione un impuesto --</option>
                            @foreach (var tax in allTaxes)
                            {
                                <option value="@tax.Id">@tax.Nombre (@tax.Porcentaje%)</option>
                            }
                        </InputSelect>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseGlobalTaxModal">Cancelar</button>
                    <button type="button" class="btn btn-primary" @onclick="ApplyGlobalTax"
                        disabled="@(selectedTaxId == Guid.Empty)">
                        <i class="bi bi-arrow-repeat me-2"></i>Aplicar a Todos
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-backdrop fade show"></div>
}

@code {
    private PaginatedList<ProductDto>? paginatedProducts;
    private string? errorMessage;

    // Paginación
    private int currentPage = 1;
    private int pageSize = 15;

    // Filtros
    private string searchTerm = string.Empty;
    private Guid? selectedCategoryId;
    private string? selectedMarca;
    private string selectedStockStatus = "All";

    // Datos para los filtros
    private List<CategoriaDto> allCategorias = new();
    private List<string> allMarcas = new();

    // Modal de Impuestos
    private Guid selectedTaxId;
    private List<TaxDto> allTaxes = new();
    private TaxDto? currentGlobalTax;
    private bool isGlobalTaxModalVisible = false;

    // Modal de Confirmación
    private bool showConfirmationModal = false;
    private string confirmationModalTitle = string.Empty;
    private string confirmationModalMessage = string.Empty;
    private Guid productToToggleId;

    protected override async Task OnInitializedAsync()
    {
        await LoadInitialData();
    }

    private async Task LoadInitialData()
    {
        var tasks = new List<Task>
        {
            LoadProducts(1),
            LoadTaxes(),
            LoadCurrentGlobalTax(),
            LoadCategorias(),
            LoadMarcas()
        };
        await Task.WhenAll(tasks);
    }

    private async Task LoadProducts(int page)
    {
        currentPage = page;
        errorMessage = null;
        try
        {
            paginatedProducts = await ProductService.GetProductsAsync(currentPage, pageSize, searchTerm, selectedCategoryId, selectedMarca, selectedStockStatus);
        }
        catch (Exception)
        {
            errorMessage = "Error al cargar los productos.";
        }
        StateHasChanged();
    }

    private async Task OnFilterChanged()
    {
        await LoadProducts(1);
    }

    private async Task SelectedPage(int page)
    {
        await LoadProducts(page);
    }

    private async Task LoadCategorias()
    {
        try
        {
            allCategorias = await ProductService.GetAllCategoriasAsync();
        }
        catch { errorMessage = "Error al cargar categorías."; }
    }

    private async Task LoadMarcas()
    {
        try
        {
            allMarcas = await ProductService.GetAllMarcasAsync();
        }
        catch { errorMessage = "Error al cargar marcas."; }
    }

    private async Task LoadTaxes()
    {
        try
        {
            allTaxes = await TaxService.GetActiveTaxesAsync();
        }
        catch { errorMessage = "Error al cargar los impuestos."; }
    }

    private async Task LoadCurrentGlobalTax()
    {
        try
        {
            currentGlobalTax = await ProductService.GetCurrentGlobalTaxAsync();
        }
        catch { errorMessage = "Error al cargar el impuesto global."; }
    }

    private void OpenGlobalTaxModal() => isGlobalTaxModalVisible = true;
    private void CloseGlobalTaxModal() => isGlobalTaxModalVisible = false;

    private async Task ApplyGlobalTax()
    {
        if (selectedTaxId == Guid.Empty) return;
        errorMessage = null;
        try
        {
            await ProductService.ApplyTaxToAllProductsAsync(selectedTaxId);
            CloseGlobalTaxModal();
            await LoadCurrentGlobalTax();
        }
        catch (Exception) { errorMessage = "Error al aplicar el impuesto global."; }
    }

    private void HandleDeleteProduct(Guid id)
    {
        var productToToggle = paginatedProducts?.Items.FirstOrDefault(p => p.Id == id);
        if (productToToggle == null) return;

        productToToggleId = id;
        confirmationModalTitle = "Confirmar Acción";
        confirmationModalMessage = $"¿Está seguro de que desea {(productToToggle.IsActive ? "desactivar" : "activar")} el producto {productToToggle.Nombre}?";
        showConfirmationModal = true;
    }

    private async Task ConfirmToggleProductStatus()
    {
        showConfirmationModal = false;
        try
        {
            await ProductService.DeleteProductAsync(productToToggleId);
            await LoadProducts(currentPage); // Recargar la página actual
        }
        catch (Exception)
        {
            var product = paginatedProducts?.Items.FirstOrDefault(p => p.Id == productToToggleId);
            var action = product != null && product.IsActive ? "desactivar" : "activar";
            errorMessage = $"Error al {action} el producto.";
        }
    }

    private void CancelToggleProductStatus()
    {
        showConfirmationModal = false;
        productToToggleId = Guid.Empty;
    }

    private void GoToCreateProduct()
    {
        Navigation.NavigateTo("/products/create");
    }
}
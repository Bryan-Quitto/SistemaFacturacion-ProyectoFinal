@using FacturasSRI.Application.Dtos
@using FacturasSRI.Application.Interfaces
@inject ITaxService TaxService
@inject IProductService ProductService

<div class="modal" tabindex="-1" style="display: @(IsVisible ? "block" : "none")">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Asignar Impuestos a @Product.Nombre</h5>
                <button type="button" class="btn-close" @onclick="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Impuestos</label>
                    <select multiple class="form-select" @onchange="OnTaxSelectionChanged">
                        @foreach (var tax in allTaxes)
                        {
                            <option value="@tax.Id" selected="@IsTaxSelected(tax.Id)">@tax.Nombre</option>
                        }
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" @onclick="Close">Cerrar</button>
                <button type="button" class="btn btn-primary" @onclick="SaveChanges">Guardar Cambios</button>
            </div>
        </div>
    </div>
</div>

@code {
    [Parameter]
    public ProductDto Product { get; set; } = default!;

    [Parameter]
    public bool IsVisible { get; set; }

    [Parameter]
    public EventCallback OnClose { get; set; }

    private List<TaxDto> allTaxes = new();
    private List<Guid> selectedTaxIds = new();

    protected override async Task OnInitializedAsync()
    {
        allTaxes = await TaxService.GetActiveTaxesAsync();
    }

    protected override void OnParametersSet()
    {
        if (Product != null)
        {
            // This is a simplification. In a real app, you would get the assigned taxes from the product.
            selectedTaxIds = new List<Guid>(); 
        }
    }

    private bool IsTaxSelected(Guid taxId)
    {
        return selectedTaxIds.Contains(taxId);
    }

    private void OnTaxSelectionChanged(ChangeEventArgs e)
    {
        selectedTaxIds.Clear();
        if (e.Value is string[] selectedValues)
        {
            foreach (var value in selectedValues)
            {
                if (Guid.TryParse(value, out var taxId))
                {
                    selectedTaxIds.Add(taxId);
                }
            }
        }
    }

    private async Task SaveChanges()
    {
        await ProductService.AssignTaxesToProductAsync(Product.Id, selectedTaxIds);
        await Close();
    }

    private async Task Close()
    {
        await OnClose.InvokeAsync();
    }
}

@using FacturasSRI.Application.Dtos
@using FacturasSRI.Application.Interfaces  // --- NUEVO ---
@inject IProductService ProductService       // --- NUEVO ---

@if (IsVisible && Product != null)
{
    <div class="modal fade show" style="display:block" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Editar Producto: @Product.Nombre</h5>
                    <button type="button" class="btn-close" @onclick="Close"></button>
                </div>
                <div class="modal-body">
                    <EditForm Model="@Product" OnValidSubmit="SaveChanges">
                        <DataAnnotationsValidator />
                        
                        <!-- Columna 1 -->
                        <div class="mb-3">
                            <label class="form-label">Nombre</label>
                            <InputText class="form-control" @bind-Value="Product.Nombre" />
                            <ValidationMessage For="@(() => Product.Nombre)" />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Código Principal</label>
                            <InputText class="form-control" @bind-Value="Product.CodigoPrincipal" />
                            <ValidationMessage For="@(() => Product.CodigoPrincipal)" />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Descripción</label>
                            <InputText class="form-control" @bind-Value="Product.Descripcion" />
                        </div>
                        
                        <!-- Columna 2 -->
                        <div class="mb-3">
                            <label class="form-label">Precio de Venta</label>
                            <InputNumber class="form-control" @bind-Value="Product.PrecioVentaUnitario" />
                            <ValidationMessage For="@(() => Product.PrecioVentaUnitario)" />
                        </div>
                        
                        <!-- --- NUEVO: Campo Marca --- -->
                        <div class="mb-3">
                            <label class="form-label">Marca</label>
                            <InputText class="form-control" @bind-Value="Product.Marca" />
                            <ValidationMessage For="@(() => Product.Marca)" />
                        </div>

                        <!-- --- NUEVO: Campo Categoría con Datalist --- -->
                        <div class="mb-3">
                            <label class="form-label">Categoría</label>
                            <InputText class="form-control" list="categorias-modal-list" @bind-Value="selectedCategoriaNombre" />
                            <datalist id="categorias-modal-list">
                                @foreach (var categoria in todasLasCategorias)
                                {
                                    <option value="@categoria.Nombre"></option>
                                }
                            </datalist>
                            <ValidationMessage For="@(() => Product.CategoriaId)" />
                        </div>

                        <!-- Checkboxes -->
                        <div class="mb-3 form-check">
                            <InputCheckbox class="form-check-input" @bind-Value="Product.ManejaInventario" />
                            <label class="form-check-label">Maneja Inventario</label>
                        </div>
                        <div class="mb-3 form-check">
                            <InputCheckbox class="form-check-input" @bind-Value="Product.ManejaLotes" />
                            <label class="form-check-label">Maneja Lotes</label>
                        </div>
                        <div class="mb-3 form-check">
                            <InputCheckbox class="form-check-input" @bind-Value="Product.IsActive" />
                            <label class="form-check-label">Está Activo</label>
                        </div>

                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" @onclick="Close">Cancelar</button>
                            <button type="submit" class="btn btn-primary">Guardar Cambios</button>
                        </div>
                    </EditForm>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-backdrop fade show"></div>
}

@code {
    [Parameter] public bool IsVisible { get; set; }
    [Parameter] public ProductDto? Product { get; set; }
    [Parameter] public EventCallback<ProductDto> OnSave { get; set; }
    [Parameter] public EventCallback OnClose { get; set; }

    // --- MODIFICADO: Las propiedades ya existían, pero ahora las usaremos ---
    private List<CategoriaDto> todasLasCategorias = new();
    private string selectedCategoriaNombre = "";

    // --- NUEVO: Este método carga los datos necesarios cuando el modal se abre ---
    protected override async Task OnParametersSetAsync()
    {
        // Solo cargamos la lista de categorías una vez para ser eficientes.
        if (IsVisible && todasLasCategorias.Count == 0)
        {
            todasLasCategorias = await ProductService.GetAllCategoriasAsync();
        }

        // Cada vez que el modal se abre, actualizamos el nombre de la categoría seleccionada.
        if (Product != null)
        {
            selectedCategoriaNombre = Product.CategoriaNombre;
        }
    }

    // --- MODIFICADO: Añadimos la lógica para convertir el nombre de la categoría a ID ---
    private async Task SaveChanges()
    {
        if (Product != null)
        {
            // 1. Buscamos la categoría completa a partir del nombre que el usuario seleccionó.
            var selectedCategoria = todasLasCategorias.FirstOrDefault(c => 
                c.Nombre.Trim().Equals(selectedCategoriaNombre.Trim(), StringComparison.CurrentCultureIgnoreCase));
            
            if (selectedCategoria != null)
            {
                // 2. Si la encontramos, actualizamos el CategoriaId del producto.
                Product.CategoriaId = selectedCategoria.Id;
            }
            else
            {
                // Opcional: Manejar el caso de que el usuario escriba una categoría que no existe.
                // Podríamos mostrar un error aquí. Por ahora, lo ignoramos.
            }
            
            // 3. Invocamos el guardado como antes. El objeto 'Product' ya está actualizado.
            await OnSave.InvokeAsync(Product);
        }
    }
    
    private async Task Close()
    {
        await OnClose.InvokeAsync();
    }
}
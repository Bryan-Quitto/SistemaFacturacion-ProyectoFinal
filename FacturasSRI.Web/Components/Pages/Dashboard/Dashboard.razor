@page "/dashboard"
@attribute [Authorize(Roles = "Administrador, Vendedor, Bodeguero")]
@using FacturasSRI.Application.Dtos
@using FacturasSRI.Application.Interfaces
@inject IDashboardService DashboardService
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject HttpClient Http
@inject NavigationManager Navigation

<PageTitle>Panel Principal</PageTitle>

<div class="dashboard-header mb-4 d-flex justify-content-between align-items-center">
    <div>
        <h1>Panel Principal</h1>
        <p class="text-muted">Bienvenido de nuevo, aquí tienes un resumen del estado de la empresa.</p>
    </div>
    <AuthorizeView Roles="Administrador">
        <button class="btn btn-sm btn-primary d-flex align-items-center" @onclick="RefreshCache" disabled="@isRefreshingCache">
            @if (isRefreshingCache)
            {
                <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                <span>Actualizando Caché...</span>
            }
            else
            {
                <i class="bi bi-arrow-clockwise me-2"></i>
                <span>Refrescar Caché</span>
            }
        </button>
    </AuthorizeView>
</div>

@if (!string.IsNullOrEmpty(cacheRefreshMessage))
{
    <div class="alert @(isCacheRefreshSuccess ? "alert-success" : "alert-danger") alert-dismissible fade show" role="alert">
        @cacheRefreshMessage
        <button type="button" class="btn-close" @onclick="ClearCacheMessage" aria-label="Close"></button>
    </div>
}

@if (stats == null && errorMessage == null)
{
    <div class="text-center p-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Cargando estadísticas...</span>
        </div>
        <p class="mt-3">Cargando estadísticas...</p>
    </div>
}
else if (errorMessage != null)
{
    <div class="alert alert-danger">
        <h4>Ha ocurrido un error inesperado.</h4>
        <p>Un problema ha impedido que la página se cargue correctamente. Por favor, inténtelo de nuevo, o revise su conexión a internet. Si el problema persiste, contacte a soporte técnico.</p>
    </div>
}
else if (stats != null)
{
    <div class="row g-4 mb-4">
        <div class="col-md-6 col-lg-4">
            <div class="card summary-card summary-card-invoices h-100">
                <div class="card-body">
                    <div class="card-icon">
                        <i class="bi bi-file-earmark-text"></i>
                    </div>
                    <div class="card-content">
                        <h4>Facturas Autorizadas</h4>
                        <p>@stats.TotalFacturasEmitidas</p>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6 col-lg-4">
            <div class="card summary-card summary-card-clients h-100">
                <div class="card-body">
                    <div class="card-icon">
                        <i class="bi bi-people"></i>
                    </div>
                    <div class="card-content">
                        <h4>Clientes Activos</h4>
                        <p>@stats.TotalClientesRegistrados</p>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6 col-lg-4">
            <div class="card summary-card summary-card-income h-100">
                <div class="card-body">
                    <div class="card-icon">
                        <i class="bi bi-cash-stack"></i>
                    </div>
                    <div class="card-content">
                        <h4>Ingresos Netos (Mes)</h4>
                        <p>@stats.IngresosEsteMes.ToString("C")</p>
                        <small class="text-muted" style="font-size: 0.75rem;">(Descontando Notas de Crédito)</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4 mb-4">
        <div class="col-lg-6">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0 text-primary"><i class="bi bi-receipt me-2"></i>Últimas Facturas</h5>
                    <a href="/invoices" class="btn btn-sm btn-outline-primary">Ver todas</a>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th class="ps-3">Nro.</th>
                                    <th>Cliente</th>
                                    <th>Fecha</th>
                                    <th class="text-end pe-3">Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                @if (stats.RecentInvoices.Any())
                                {
                                    @foreach (var invoice in stats.RecentInvoices)
                                    {
                                        <tr>
                                            <td class="ps-3 fw-bold">@invoice.NumeroFactura</td>
                                            <td class="text-truncate" style="max-width: 150px;" title="@invoice.ClienteNombre">@invoice.ClienteNombre</td>
                                            <td>@invoice.FechaEmision.ToLocalTime().ToString("dd/MM/yyyy")</td>
                                            <td class="text-end pe-3">@invoice.Total.ToString("C")</td>
                                        </tr>
                                    }
                                }
                                else
                                {
                                    <tr>
                                        <td colspan="4" class="text-center py-4 text-muted">No hay facturas recientes.</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-6">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0 text-warning"><i class="bi bi-arrow-return-left me-2"></i>Últimas Notas Crédito</h5>
                    <a href="/credit-notes" class="btn btn-sm btn-outline-warning">Ver todas</a>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th class="ps-3">Nro.</th>
                                    <th>Cliente</th>
                                    <th>Fecha</th>
                                    <th class="text-end pe-3">Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                @if (stats.RecentCreditNotes.Any())
                                {
                                    @foreach (var nc in stats.RecentCreditNotes)
                                    {
                                        <tr>
                                            <td class="ps-3 fw-bold">@nc.NumeroNotaCredito</td>
                                            <td class="text-truncate" style="max-width: 150px;" title="@nc.ClienteNombre">@nc.ClienteNombre</td>
                                            <td>@nc.FechaEmision.ToLocalTime().ToString("dd/MM/yyyy")</td>
                                            <td class="text-end pe-3 text-danger">-@nc.Total.ToString("C")</td>
                                        </tr>
                                    }
                                }
                                else
                                {
                                    <tr>
                                        <td colspan="4" class="text-center py-4 text-muted">No hay notas de crédito recientes.</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0"><i class="bi bi-graph-up-arrow me-2"></i>Productos Más Vendidos</h5>
                    <a href="/products" class="btn btn-sm btn-outline-secondary">Inventario</a>
                </div>
                <div class="card-body">
                    @if (stats.TopProducts.Any())
                    {
                        <div class="row g-3">
                            @foreach (var product in stats.TopProducts)
                            {
                                <div class="col-md-6 col-lg-4 col-xl-2">
                                    <div class="border rounded p-3 text-center h-100 bg-light">
                                        <div class="mb-2 text-primary">
                                            <i class="bi bi-box-seam fs-3"></i>
                                        </div>
                                        <h6 class="text-truncate" title="@product.ProductName">@product.ProductName</h6>
                                        <div class="d-flex justify-content-center align-items-center gap-2 mt-2">
                                            <span class="badge bg-primary">@product.QuantitySold unds.</span>
                                        </div>
                                        <small class="text-muted d-block mt-1">@product.TotalRevenue.ToString("C")</small>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="text-center py-4 text-muted">
                            <i class="bi bi-basket fs-1 d-block mb-2"></i>
                            No hay ventas registradas aún.
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
}

@code {
    private DashboardStatsDto? stats;
    private string? errorMessage;

    private bool isRefreshingCache = false;
    private string? cacheRefreshMessage;
    private bool isCacheRefreshSuccess = false;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            stats = await DashboardService.GetDashboardStatsAsync();
        }
        catch (Exception)
        {
            errorMessage = "No se pudieron cargar las estadísticas.";
        }
    }

    private async Task RefreshCache()
    {
        isRefreshingCache = true;
        cacheRefreshMessage = null;
        isCacheRefreshSuccess = false;

        try
        {
            var requestUri = new Uri(Navigation.ToAbsoluteUri(Navigation.BaseUri), "api/admin/refresh-cache");
            var response = await Http.PostAsync(requestUri, null);
            
            if (response.IsSuccessStatusCode)
            {
                isCacheRefreshSuccess = true;
                cacheRefreshMessage = "Caché de datos actualizada exitosamente.";
            }
            else
            {
                isCacheRefreshSuccess = false;
                cacheRefreshMessage = $"Error al actualizar la caché: {response.ReasonPhrase}";
            }
        }
        catch (Exception ex)
        {
            isCacheRefreshSuccess = false;
            cacheRefreshMessage = $"Error de red al actualizar la caché: {ex.Message}";
        }
        finally
        {
            isRefreshingCache = false;
        }
    }

    private void ClearCacheMessage()
    {
        cacheRefreshMessage = null;
    }
}
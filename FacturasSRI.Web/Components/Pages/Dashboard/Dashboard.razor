@page "/dashboard"
@attribute [Authorize(Roles = "Administrador, Vendedor, Bodeguero")]
@using FacturasSRI.Application.Dtos
@using FacturasSRI.Application.Interfaces
@using System.Security.Claims
@inject IDashboardService DashboardService
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject HttpClient Http
@inject NavigationManager Navigation

<PageTitle>Panel Principal</PageTitle>

<div class="dashboard-header mb-4 d-flex justify-content-between align-items-center">
    <div>
        <h1>Panel Principal</h1>
        <p class="text-muted">
            @if (isBodeguero && !isAdmin)
            {
                <span>Gestión operativa de inventario.</span>
            }
            else if (!isAdmin)
            {
                <span>Resumen de tus ventas y rendimiento.</span>
            }
            else
            {
                <span>Visión global de la empresa.</span>
            }
        </p>
    </div>
    <AuthorizeView Roles="Administrador">
        <button class="btn btn-sm btn-primary d-flex align-items-center" @onclick="RefreshCache" disabled="@isRefreshingCache">
            @if (isRefreshingCache)
            {
                <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                <span>Actualizando...</span>
            }
            else
            {
                <i class="bi bi-arrow-clockwise me-2"></i>
                <span>Refrescar Caché</span>
            }
        </button>
    </AuthorizeView>
</div>

@* ALERTAS GLOBALES (Con botón de cerrar) *@
@if (showLowStockAlert && (isAdmin || isBodeguero) && stats?.TotalProductosBajoStock > 0)
{
    <div class="alert alert-danger alert-dismissible fade show d-flex align-items-center shadow-sm mb-4" role="alert">
        <i class="bi bi-exclamation-triangle-fill fs-4 me-3"></i>
        <div>
            <strong>Atención:</strong> Hay <strong>@stats.TotalProductosBajoStock</strong> productos con stock crítico.
            <a href="/reports/warehouse/low-stock-products" class="alert-link">Ver reporte</a>.
        </div>
        @* Botón X para cerrar *@
        <button type="button" class="btn-close" @onclick="() => showLowStockAlert = false" aria-label="Close"></button>
    </div>
}

@if (!string.IsNullOrEmpty(cacheRefreshMessage))
{
    <div class="alert @(isCacheRefreshSuccess ? "alert-success" : "alert-danger") alert-dismissible fade show" role="alert">
        @cacheRefreshMessage
        <button type="button" class="btn-close" @onclick="ClearCacheMessage" aria-label="Close"></button>
    </div>
}

@if (stats == null && errorMessage == null)
{
    <div class="text-center p-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Cargando estadísticas...</span>
        </div>
        <p class="mt-3">Cargando estadísticas...</p>
    </div>
}
else if (errorMessage != null)
{
    <div class="alert alert-danger">
        <h4><i class="bi bi-exclamation-triangle me-2"></i>Error</h4>
        <p>@errorMessage</p>
    </div>
}
else if (stats != null)
{
    @* --- TARJETAS SUPERIORES (KPIs) --- *@
    <div class="row g-4 mb-4">
        
        @if (isBodeguero && !isAdmin)
        {
            @* DISEÑO BODEGUERO: 2 Columnas Anchas (Sin relleno) *@
            <div class="col-md-6">
                <div class="card h-100 shadow-sm border-start border-4 border-primary">
                    <div class="card-body d-flex align-items-center justify-content-between">
                        <div>
                            <div class="text-primary fw-bold text-uppercase small mb-1">Compras del Mes</div>
                            <h2 class="mb-0 fw-bold">@stats.TotalComprasMes</h2>
                            <small class="text-muted">Registradas</small>
                        </div>
                        <div class="bg-primary bg-opacity-10 p-3 rounded-circle text-primary">
                            <i class="bi bi-bag-check fs-3"></i>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card h-100 shadow-sm border-start border-4 border-warning">
                    <div class="card-body d-flex align-items-center justify-content-between">
                        <div>
                            <div class="text-warning fw-bold text-uppercase small mb-1">Alerta de Stock</div>
                            <h2 class="mb-0 fw-bold">@stats.TotalProductosBajoStock</h2>
                            <small class="text-muted">Productos bajos</small>
                        </div>
                        <div class="bg-warning bg-opacity-10 p-3 rounded-circle text-warning">
                            <i class="bi bi-exclamation-triangle fs-3"></i>
                        </div>
                    </div>
                </div>
            </div>
        }
        else
        {
            @* DISEÑO ADMIN/VENDEDOR: 3 Columnas (Estándar) *@
            <div class="col-md-6 col-lg-4">
                <div class="card h-100 shadow-sm border-start border-4 border-primary">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <div class="text-primary fw-bold text-uppercase small">Facturas Emitidas</div>
                            <div class="text-primary"><i class="bi bi-receipt fs-4"></i></div>
                        </div>
                        <h3 class="mb-0 fw-bold">@stats.TotalFacturasEmitidas</h3>
                        <small class="text-muted">Total histórico</small>
                    </div>
                </div>
            </div>

            <div class="col-md-6 col-lg-4">
                <div class="card h-100 shadow-sm border-start border-4 border-info">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <div class="text-info fw-bold text-uppercase small">Clientes Activos</div>
                            <div class="text-info"><i class="bi bi-people fs-4"></i></div>
                        </div>
                        <h3 class="mb-0 fw-bold">@stats.TotalClientesRegistrados</h3>
                        <small class="text-muted">En el sistema</small>
                    </div>
                </div>
            </div>

            <div class="col-md-6 col-lg-4">
                <div class="card h-100 shadow-sm border-start border-4 border-success">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <div class="text-success fw-bold text-uppercase small">Ventas Netas (Mes)</div>
                            <div class="text-success"><i class="bi bi-cash-stack fs-4"></i></div>
                        </div>
                        <h3 class="mb-0 fw-bold">@stats.IngresosEsteMes.ToString("C")</h3>
                        <small class="text-muted">@(isAdmin ? "Global de la empresa" : "Tus ventas")</small>
                    </div>
                </div>
            </div>
        }
    </div>

    @* --- SECCIÓN PRINCIPAL --- *@

    <div class="row g-4 mb-4">
        
        @* COLUMNA IZQUIERDA *@
        <div class="col-lg-6">
            @if (isBodeguero && !isAdmin)
            {
                @* BODEGUERO: Widget de Stock Bajo (Prioridad Alta) *@
                <div class="card shadow-sm border-0 h-100">
                    <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0 text-danger"><i class="bi bi-list-check me-2"></i>Reponer Stock</h5>
                        <a href="/reports/warehouse/low-stock-products" class="btn btn-sm btn-outline-secondary">Ver todo</a>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th class="ps-3">Producto</th>
                                        <th class="text-end">Mín</th>
                                        <th class="text-end pe-3">Actual</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @if (stats.LowStockProducts.Any())
                                    {
                                        @foreach (var prod in stats.LowStockProducts)
                                        {
                                            <tr>
                                                <td class="ps-3 text-truncate" style="max-width: 200px;">@prod.ProductName</td>
                                                <td class="text-end text-muted">@prod.StockMinimo.ToString("N0")</td>
                                                <td class="text-end pe-3 fw-bold text-danger">@prod.StockActual.ToString("N0")</td>
                                            </tr>
                                        }
                                    }
                                    else
                                    {
                                        <tr><td colspan="3" class="text-center py-5 text-success">
                                            <i class="bi bi-check-circle fs-1 d-block mb-2"></i>
                                            Sin alertas de stock.
                                        </td></tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            }
            else
            {
                @* VENDEDOR/ADMIN: Últimas Facturas *@
                <div class="card shadow-sm border-0 h-100">
                    <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0 text-primary"><i class="bi bi-receipt me-2"></i>Últimas Facturas</h5>
                        <a href="/invoices" class="btn btn-sm btn-outline-primary">Ver todas</a>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th class="ps-3">Nro.</th>
                                        <th>Cliente</th>
                                        <th class="text-end pe-3">Total</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @if (stats.RecentInvoices.Any())
                                    {
                                        @foreach (var invoice in stats.RecentInvoices)
                                        {
                                            <tr>
                                                <td class="ps-3 fw-bold">@invoice.NumeroFactura</td>
                                                <td class="text-truncate" style="max-width: 150px;">@invoice.ClienteNombre</td>
                                                <td class="text-end pe-3">@invoice.Total.ToString("C")</td>
                                            </tr>
                                        }
                                    }
                                    else
                                    {
                                        <tr><td colspan="3" class="text-center py-4 text-muted">No hay facturas recientes.</td></tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            }
        </div>

        @* COLUMNA DERECHA *@
        <div class="col-lg-6">
             @if (isBodeguero && !isAdmin)
            {
                @* BODEGUERO: ACCESOS RÁPIDOS (Estilo Panel de Control) *@
                 <div class="card shadow-sm border-0 h-100">
                    <div class="card-header bg-white py-3">
                        <h5 class="card-title mb-0"><i class="bi bi-grid me-2"></i>Acciones Rápidas</h5>
                    </div>
                    <div class="card-body">
                        <div class="list-group list-group-flush border rounded-3">
                            <a href="/purchases/create" class="list-group-item list-group-item-action d-flex align-items-center py-3">
                                <div class="bg-primary bg-opacity-10 text-primary rounded p-2 me-3">
                                    <i class="bi bi-cart-plus fs-5"></i>
                                </div>
                                <div>
                                    <div class="fw-bold text-dark">Registrar Compra</div>
                                    <small class="text-muted">Ingresar nueva mercadería</small>
                                </div>
                                <i class="bi bi-chevron-right ms-auto text-muted"></i>
                            </a>
                            
                            <a href="/inventory/adjustments/create" class="list-group-item list-group-item-action d-flex align-items-center py-3">
                                <div class="bg-warning bg-opacity-10 text-warning rounded p-2 me-3">
                                    <i class="bi bi-sliders fs-5"></i>
                                </div>
                                <div>
                                    <div class="fw-bold text-dark">Ajuste de Inventario</div>
                                    <small class="text-muted">Corregir stock (Daño/Merma)</small>
                                </div>
                                <i class="bi bi-chevron-right ms-auto text-muted"></i>
                            </a>

                            <a href="/reports/warehouse/current-stock" class="list-group-item list-group-item-action d-flex align-items-center py-3">
                                <div class="bg-info bg-opacity-10 text-info rounded p-2 me-3">
                                    <i class="bi bi-clipboard-data fs-5"></i>
                                </div>
                                <div>
                                    <div class="fw-bold text-dark">Consultar Stock</div>
                                    <small class="text-muted">Ver inventario valorizado</small>
                                </div>
                                <i class="bi bi-chevron-right ms-auto text-muted"></i>
                            </a>
                        </div>
                    </div>
                </div>
            }
            else
            {
                 @* VENDEDOR/ADMIN: Últimas Notas Crédito *@
                <div class="card shadow-sm border-0 h-100">
                    <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0 text-warning"><i class="bi bi-arrow-return-left me-2"></i>Devoluciones Recientes</h5>
                        <a href="/credit-notes" class="btn btn-sm btn-outline-warning">Ver todas</a>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th class="ps-3">Nro.</th>
                                        <th>Cliente</th>
                                        <th class="text-end pe-3">Total</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @if (stats.RecentCreditNotes.Any())
                                    {
                                        @foreach (var nc in stats.RecentCreditNotes)
                                        {
                                            <tr>
                                                <td class="ps-3 fw-bold">@nc.NumeroNotaCredito</td>
                                                <td class="text-truncate" style="max-width: 150px;">@nc.ClienteNombre</td>
                                                <td class="text-end pe-3 text-danger">-@nc.Total.ToString("C")</td>
                                            </tr>
                                        }
                                    }
                                    else
                                    {
                                        <tr><td colspan="3" class="text-center py-4 text-muted">No hay notas de crédito recientes.</td></tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>

    @* --- SECCIÓN INFERIOR: PRODUCTOS TOP (Solo Admin y Vendedor) --- *@
    @if (!isBodeguero || isAdmin)
    {
        <div class="row">
            <div class="col-12">
                <div class="card shadow-sm border-0">
                    <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0"><i class="bi bi-graph-up-arrow me-2"></i>Productos Más Vendidos</h5>
                        <a href="/products" class="btn btn-sm btn-outline-secondary">Inventario</a>
                    </div>
                    <div class="card-body">
                        @if (stats.TopProducts.Any())
                        {
                            <div class="row g-3">
                                @foreach (var product in stats.TopProducts)
                                {
                                    <div class="col-md-6 col-lg-4 col-xl-2">
                                        <div class="border rounded p-3 text-center h-100 bg-light">
                                            <div class="mb-2 text-primary">
                                                <i class="bi bi-box-seam fs-3"></i>
                                            </div>
                                            <h6 class="text-truncate" title="@product.ProductName">@product.ProductName</h6>
                                            <span class="badge bg-primary">@product.QuantitySold unds.</span>
                                            @if(isAdmin) 
                                            {
                                                <small class="text-muted d-block mt-1">@product.TotalRevenue.ToString("C")</small>
                                            }
                                        </div>
                                    </div>
                                }
                            </div>
                        }
                        else
                        {
                            <div class="text-center py-4 text-muted">
                                No hay ventas registradas aún.
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    }
}

@code {
    private DashboardStatsDto? stats;
    private string? errorMessage;
    private bool isRefreshingCache = false;
    private string? cacheRefreshMessage;
    private bool isCacheRefreshSuccess = false;

    // Control de roles y UI
    private bool isAdmin = false;
    private bool isBodeguero = false;
    private bool isVendedor = false;
    private bool showLowStockAlert = true; // Controla la visibilidad de la alerta

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;

            if (user.Identity != null && user.Identity.IsAuthenticated)
            {
                isAdmin = user.IsInRole("Administrador");
                isBodeguero = user.IsInRole("Bodeguero");
                isVendedor = user.IsInRole("Vendedor");

                var userIdClaim = user.FindFirst(ClaimTypes.NameIdentifier);
                if (Guid.TryParse(userIdClaim?.Value, out var userId))
                {
                    stats = await DashboardService.GetDashboardStatsAsync(userId, isAdmin, isBodeguero);
                }
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"No se pudieron cargar las estadísticas: {ex.Message}";
        }
    }

    private async Task RefreshCache()
    {
        isRefreshingCache = true;
        cacheRefreshMessage = null;
        try
        {
            var requestUri = new Uri(Navigation.ToAbsoluteUri(Navigation.BaseUri), "api/admin/refresh-cache");
            var response = await Http.PostAsync(requestUri, null);
            isCacheRefreshSuccess = response.IsSuccessStatusCode;
            cacheRefreshMessage = isCacheRefreshSuccess ? "Caché actualizada." : "Error al actualizar caché.";
        }
        catch (Exception ex)
        {
            isCacheRefreshSuccess = false;
            cacheRefreshMessage = $"Error: {ex.Message}";
        }
        finally
        {
            isRefreshingCache = false;
        }
    }

    private void ClearCacheMessage()
    {
        cacheRefreshMessage = null;
    }
}
@page "/payments/details/{FacturaId:guid}"
@attribute [Authorize(Roles = "Administrador, Vendedor")]
@using FacturasSRI.Application.Dtos
@using FacturasSRI.Application.Interfaces
@using FacturasSRI.Domain.Enums
@inject IInvoiceService InvoiceService
@inject ICobroService CobroService
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime

<PageTitle>Pagos de Factura - @(invoice?.NumeroFactura ?? "...")</PageTitle>

@if (invoice == null && !isLoading)
{
    <div class="alert alert-danger">No se encontró la factura especificada o no tiene pagos registrados.</div>
}
else if (isLoading)
{
    <div class="text-center p-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Cargando...</span>
        </div>
        <p class="mt-3">Cargando detalles de pagos...</p>
    </div>
}
else
{
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="page-title mb-0">Detalles de Pagos de Factura</h1>
        <div>
            <button class="btn btn-outline-secondary me-2" @onclick="GoBack">
                <i class="bi bi-arrow-left-circle me-2"></i>Volver al Historial
            </button>
            <a href="@($"invoices/{FacturaId}")" class="btn btn-outline-info" title="Ver Factura Completa">
                <i class="bi bi-file-earmark-text"></i> Ver Factura
            </a>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-body">
            <h5 class="card-title">Información de la Factura</h5>
            <div class="row">
                <div class="col-md-6">
                    <p class="mb-1"><strong>Número de Factura:</strong> @invoice!.NumeroFactura</p>
                    <p class="mb-1"><strong>Cliente:</strong> @invoice.ClienteNombre</p>
                    <p class="mb-1"><strong>Fecha Emisión:</strong> @invoice.FechaEmision.ToLocalTime().ToString("g")</p>
                </div>
                <div class="col-md-6">
                    <p class="mb-1"><strong>Total Factura:</strong> @invoice.Total.ToString("C")</p>
                    <p class="mb-1"><strong>Forma de Pago:</strong> @invoice.FormaDePago.ToString()</p>
                    <p class="mb-1"><strong>Saldo Pendiente:</strong> <span class="text-danger">@invoice.SaldoPendiente.ToString("C")</span></p>
                </div>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <h5 class="card-title mb-0">Pagos Registrados</h5>
        </div>
        <div class="card-body">
            @if (!cobros.Any())
            {
                <p>No se han registrado pagos para esta factura.</p>
            }
            else
            {
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Método de Pago</th>
                                <th>Referencia</th>
                                <th>Registrado Por</th>
                                <th class="text-end">Monto</th>
                                <th class="text-center">Comprobante</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var cobro in cobros)
                            {
                                <tr>
                                    <td>@cobro.FechaCobro.ToLocalTime().ToString("g")</td>
                                    <td>@cobro.MetodoDePago</td>
                                    <td>@(cobro.Referencia ?? "N/A")</td>
                                    <td>@cobro.CreadoPor</td>
                                    <td class="text-end">@cobro.Monto.ToString("C")</td>
                                    <td class="text-center">
                                        @if (!string.IsNullOrEmpty(cobro.ComprobantePagoPath))
                                        {
                                            <button class="btn btn-sm btn-outline-success" @onclick="() => DownloadCobroReceipt(cobro.Id)">
                                                <i class="bi bi-download"></i>
                                            </button>
                                        }
                                        else
                                        {
                                            <span>N/A</span>
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
        </div>
    </div>
}

@code {
    [Parameter]
    public Guid FacturaId { get; set; }

    private InvoiceDetailViewDto? invoice;
    private List<CobroDto> cobros = new();
    private bool isLoading = true;
    private string? errorMessage;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        try
        {
            isLoading = true;
            invoice = await InvoiceService.GetInvoiceDetailByIdAsync(FacturaId);
            if (invoice != null)
            {
                cobros = await CobroService.GetCobrosByFacturaIdAsync(FacturaId);
            }
            else
            {
                errorMessage = "No se encontró la factura solicitada o no se pudieron cargar sus pagos.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error al cargar los detalles de pago: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private void GoBack()
    {
        Navigation.NavigateTo("/payments");
    }

    private async Task DownloadCobroReceipt(Guid cobroId)
    {
        var url = $"/api/downloads/invoice-receipt/{cobroId}";
        await JSRuntime.InvokeVoidAsync("open", url, "_blank");
    }
}

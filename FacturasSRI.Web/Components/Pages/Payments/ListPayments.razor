@page "/payments"
@attribute [Authorize(Roles = "Administrador, Vendedor")]
@using FacturasSRI.Application.Dtos
@using FacturasSRI.Application.Interfaces
@using FacturasSRI.Domain.Enums
@using FacturasSRI.Web.Components.Shared
@inject ICobroService CobroService
@inject NavigationManager Navigation

<PageTitle>Facturas con Pagos</PageTitle>

<div class="d-flex justify-content-between align-items-center mb-3">
    <div>
        <h1>Pagos y Cobros</h1>
        <p class="text-muted mb-0">Consulta el estado de cobro de las facturas emitidas.</p>
    </div>
</div>

<div class="row g-2 mb-3">
    <div class="col-md-6">
        <input type="text" class="form-control" placeholder="Buscar por número de factura o cliente..." 
               @bind="searchTerm" @bind:event="oninput" @onkeyup="OnFilterChanged" />
    </div>
    <div class="col-md-3">
        <InputSelect class="form-select" @bind-Value="selectedFormaDePago" @bind-Value:after="OnFilterChanged">
            <option value="">Todas las Formas de Pago</option>
            @foreach (var s in Enum.GetValues(typeof(FormaDePago)))
            {
                <option value="@s">@s.ToString()</option>
            }
        </InputSelect>
    </div>
    <div class="col-md-3">
        <InputSelect class="form-select" @bind-Value="selectedEstadoFactura" @bind-Value:after="OnFilterChanged">
            <option value="">Todos los Estados</option>
            @foreach (var s in Enum.GetValues(typeof(EstadoFactura)))
            {
                <option value="@s">@s.ToString()</option>
            }
        </InputSelect>
    </div>
</div>

@if (errorMessage != null)
{
    <div class="alert alert-danger mb-4 shadow-sm border-0">
        <i class="bi bi-exclamation-triangle-fill me-2"></i> @errorMessage
    </div>
}

@if (paginatedFacturasConPagos == null)
{
    <p><em>Cargando historial...</em></p>
}
else if (paginatedFacturasConPagos.Items.Any())
{
    <div class="table-responsive">
        <table class="table table-hover align-middle">
            <thead>
                <tr>
                    <th>Factura</th>
                    <th>Cliente</th>
                    <th>Fecha Emisión</th>
                    <th>Forma de Pago</th>
                    <th>Estado SRI</th>
                    <th class="text-end">Total</th>
                    <th class="text-end">Pagado</th>
                    <th class="text-end">Pendiente</th>
                    <th class="text-end">Acciones</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var factura in paginatedFacturasConPagos.Items)
                {
                    <tr>
                        <td class="fw-bold">@factura.NumeroFactura</td>
                        <td>@factura.ClienteNombre</td>
                        <td>@factura.FechaEmision.ToString("dd/MM/yyyy")</td>
                        <td>
                            <span class="badge @(factura.FormaDePago == FormaDePago.Credito ? "bg-info text-dark" : "bg-light text-dark border")">
                                @factura.FormaDePago
                            </span>
                        </td>
                        <td>
                            @if (factura.EstadoFactura == EstadoFactura.Autorizada)
                            {
                                <span class="badge bg-success">Autorizada</span>
                            }
                            else
                            {
                                <span class="badge bg-danger">@factura.EstadoFactura</span>
                            }
                        </td>
                        <td class="text-end fw-bold">@factura.TotalFactura.ToString("C")</td>
                        <td class="text-end text-success">@factura.TotalPagado.ToString("C")</td>
                        <td class="text-end">
                            @if (factura.SaldoPendiente > 0)
                            {
                                <span class="text-danger fw-bold">@factura.SaldoPendiente.ToString("C")</span>
                            }
                            else
                            {
                                <span class="badge bg-light text-success border border-success"><i class="bi bi-check-circle-fill me-1"></i>Pagada</span>
                            }
                        </td>
                        <td class="text-end">
                            <a href="@($"payments/details/{factura.FacturaId}")" class="btn btn-sm btn-outline-primary" title="Ver Historial de Pagos">
                                <i class="bi bi-wallet2"></i>
                            </a>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
    
    <div class="d-flex justify-content-between align-items-center mt-3">
        <p class="text-muted mb-0 small">
            Mostrando del @((currentPage - 1) * pageSize + 1) al @Math.Min(currentPage * pageSize, paginatedFacturasConPagos.TotalCount) de @paginatedFacturasConPagos.TotalCount registros.
        </p>
        <Pagination CurrentPage="currentPage" 
                    TotalPages="paginatedFacturasConPagos.TotalPages" 
                    OnPageSelected="SelectedPage" />
    </div>
}
else
{
    <div class="alert alert-light border text-center py-4">
        <i class="bi bi-search display-6 text-muted mb-3 d-block"></i>
        No se encontraron facturas con los filtros seleccionados.
    </div>
}

@code {
    private PaginatedList<FacturasConPagosDto>? paginatedFacturasConPagos;
    private string? errorMessage;
    
    private int currentPage = 1;
    private int pageSize = 15;
    private string searchTerm = string.Empty;
    private FormaDePago? selectedFormaDePago;
    private EstadoFactura? selectedEstadoFactura;

    protected override async Task OnInitializedAsync()
    {
        await LoadData(currentPage);
    }

    private async Task LoadData(int page)
    {
        currentPage = page;
        errorMessage = null;
        try
        {
            paginatedFacturasConPagos = await CobroService.GetFacturasConPagosAsync(currentPage, pageSize, searchTerm, selectedFormaDePago, selectedEstadoFactura);
            StateHasChanged();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error al cargar historial: {ex.Message}";
        }
    }

    private async Task OnFilterChanged()
    {
        await LoadData(1);
    }

    private async Task SelectedPage(int page)
    {
        await LoadData(page);
    }
}
@page "/payments"
@attribute [Authorize(Roles = "Administrador, Vendedor")]
@using FacturasSRI.Application.Dtos
@using FacturasSRI.Application.Interfaces
@using FacturasSRI.Domain.Enums
@inject ICobroService CobroService
@inject NavigationManager Navigation

<PageTitle>Facturas con Pagos</PageTitle>

<div class="d-flex justify-content-between align-items-center mb-3">
    <div>
        <h1>Pagos y Cobros</h1>
        <p class="text-muted mb-0">Consulta el estado de cobro de las facturas emitidas.</p>
    </div>
</div>

<div class="row g-2 mb-3">
    <div class="col-md-6">
        <input type="text" class="form-control" placeholder="Buscar por nÃºmero de factura o cliente..." @bind-value="searchTerm" @bind-value:event="oninput" />
    </div>
    <div class="col-md-3">
        <InputSelect class="form-select" @bind-Value="selectedFormaDePago">
            <option value="">Todas las Formas de Pago</option>
            @foreach (var s in Enum.GetValues(typeof(FormaDePago)))
            {
                <option value="@s">@s.ToString()</option>
            }
        </InputSelect>
    </div>
    <div class="col-md-3">
        <InputSelect class="form-select" @bind-Value="selectedEstadoFactura">
            <option value="">Todos los Estados</option>
            @foreach (var s in Enum.GetValues(typeof(EstadoFactura)))
            {
                <option value="@s">@s.ToString()</option>
            }
        </InputSelect>
    </div>
</div>

@if (errorMessage != null)
{
    <div class="alert alert-danger mb-4 shadow-sm border-0">
        <i class="bi bi-exclamation-triangle-fill me-2"></i> @errorMessage
    </div>
}

@if (allFacturasConPagos == null)
{
    <p><em>Cargando historial...</em></p>
}
else
{
    <div class="table-responsive">
        <table class="table table-hover align-middle">
            <thead>
                <tr>
                    <th>Factura</th>
                    <th>Cliente</th>
                    <th>Forma de Pago</th>
                    <th>Estado SRI</th>
                    <th class="text-end">Total</th>
                    <th class="text-end">Pagado</th>
                    <th class="text-end">Pendiente</th>
                    <th class="text-end">Acciones</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var factura in FilteredFacturasConPagos)
                {
                    <tr>
                        <td class="fw-bold">@factura.NumeroFactura</td>
                        <td>@factura.ClienteNombre</td>
                        <td>
                            <span class="badge @(factura.FormaDePago == FormaDePago.Credito ? "bg-info text-dark" : "bg-light text-dark border")">
                                @factura.FormaDePago
                            </span>
                        </td>
                        <td>
                            @if (factura.EstadoFactura == EstadoFactura.Autorizada)
                            {
                                <span class="badge bg-success">Autorizada</span>
                            }
                            else
                            {
                                <span class="badge bg-danger">@factura.EstadoFactura</span>
                            }
                        </td>
                        <td class="text-end fw-bold">@factura.TotalFactura.ToString("C")</td>
                        <td class="text-end text-success">@factura.TotalPagado.ToString("C")</td>
                        <td class="text-end">
                            @if (factura.SaldoPendiente > 0)
                            {
                                <span class="text-danger fw-bold">@factura.SaldoPendiente.ToString("C")</span>
                            }
                            else
                            {
                                <span class="badge bg-light text-success border border-success"><i class="bi bi-check-circle-fill me-1"></i>Pagada</span>
                            }
                        </td>
                        <td class="text-end">
                            <a href="@($"payments/details/{factura.FacturaId}")" class="btn btn-sm btn-outline-primary" title="Ver Historial de Pagos">
                                <i class="bi bi-wallet2"></i>
                            </a>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
}

@code {
    private List<FacturasConPagosDto>? allFacturasConPagos;
    private string? errorMessage;
    private string searchTerm = string.Empty;
    private FormaDePago? selectedFormaDePago;
    private EstadoFactura? selectedEstadoFactura;

    private List<FacturasConPagosDto> FilteredFacturasConPagos
    {
        get
        {
            var filtered = allFacturasConPagos;

            if (filtered == null) return new List<FacturasConPagosDto>();

            if (selectedFormaDePago.HasValue)
            {
                filtered = filtered.Where(f => f.FormaDePago == selectedFormaDePago.Value).ToList();
            }

            if (selectedEstadoFactura.HasValue)
            {
                filtered = filtered.Where(f => f.EstadoFactura == selectedEstadoFactura.Value).ToList();
            }

            if (!string.IsNullOrWhiteSpace(searchTerm))
            {
                filtered = filtered.Where(f => f.NumeroFactura.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
                                                (f.ClienteNombre?.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ?? false))
                                     .ToList();
            }

            return filtered;
        }
    }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            allFacturasConPagos = await CobroService.GetFacturasConPagosAsync();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error al cargar historial: {ex.Message}";
        }
    }
}
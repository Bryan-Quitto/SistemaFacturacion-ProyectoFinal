@page "/taxes"
@attribute [Authorize(Roles = "Administrador")]
@using FacturasSRI.Application.Dtos
@using FacturasSRI.Application.Interfaces
@using FacturasSRI.Web.Components.Shared
@inject ITaxService TaxService
@inject NavigationManager Navigation

<PageTitle>Lista de Impuestos</PageTitle>

<div class="d-flex justify-content-between align-items-center mb-3">
    <h1>Impuestos</h1>
    <button class="btn btn-primary" @onclick="GoToCreateTax">
        <i class="bi bi-plus-circle-fill me-2"></i>Crear Nuevo Impuesto
    </button>
</div>

<div class="row mb-3">
    <div class="col-12">
        <input type="text" class="form-control" placeholder="Buscar impuestos por nombre o código SRI..." @bind-value="searchTerm" @bind-value:event="oninput" />
    </div>
</div>

@if (!string.IsNullOrEmpty(statusMessage))
{
    <div class="alert @(isSuccess ? "alert-success" : "alert-danger") mb-4 shadow-sm border-0" role="alert">
        <i class="bi @(isSuccess ? "bi-check-circle-fill" : "bi-exclamation-triangle-fill") me-2"></i> @statusMessage
        <button type="button" class="btn-close float-end" @onclick="ClearStatusMessage" aria-label="Close"></button>
    </div>
}

<div class="table-responsive">
    <table class="table table-hover align-middle">
        <thead>
            <tr>
                <th>Nombre</th>
                <th>Código SRI</th>
                <th>Porcentaje</th>
                <th>Estado</th>
                <th class="text-end">Acciones</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var tax in FilteredTaxes)
            {
                <tr>
                    <td class="fw-medium">@tax.Nombre</td>
                    <td><span class="badge bg-light text-dark border">@tax.CodigoSRI</span></td>
                    <td>@tax.Porcentaje%</td>
                    <td>
                        @if (tax.EstaActivo)
                        {
                            <span class="badge bg-success">Activo</span>
                        }
                        else
                        {
                            <span class="badge bg-secondary">Inactivo</span>
                        }
                    </td>
                    <td class="text-end">
                        <div class="btn-group shadow-sm" role="group">
                            <a href="@($"/taxes/edit/{tax.Id}")" class="btn btn-sm btn-outline-secondary" title="Editar">
                                <i class="bi bi-pencil-fill"></i>
                            </a>
                            <button class="btn btn-sm @(tax.EstaActivo ? "btn-outline-danger" : "btn-outline-success")" 
                                    @onclick="() => HandleDeleteTax(tax.Id)" 
                                    title="@(tax.EstaActivo ? "Desactivar" : "Activar")">
                                <i class="bi @(tax.EstaActivo ? "bi-trash-fill" : "bi-check-circle-fill")"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>

<ConfirmationModal IsVisible="showConfirmationModal"
                   Title="@confirmationModalTitle"
                   Message="@confirmationModalMessage"
                   OnConfirm="ConfirmToggleTaxStatus"
                   OnCancel="CancelToggleTaxStatus" />

@code {
    private List<TaxDto> allTaxes = new();
    private bool showConfirmationModal = false;
    private string confirmationModalTitle = string.Empty;
    private string confirmationModalMessage = string.Empty;
    private Guid taxToToggleId;
    private string? statusMessage;
    private bool isSuccess;
    private string searchTerm = string.Empty;

    private List<TaxDto> FilteredTaxes => string.IsNullOrWhiteSpace(searchTerm)
        ? allTaxes
        : allTaxes.Where(t => t.Nombre.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
                                t.CodigoSRI.Contains(searchTerm, StringComparison.OrdinalIgnoreCase))
                      .ToList();

    protected override async Task OnInitializedAsync()
    {
        await LoadTaxes();
    }

    private async Task LoadTaxes()
    {
        allTaxes = await TaxService.GetTaxesAsync();
    }

    private void HandleDeleteTax(Guid id)
    {
        var taxToToggle = allTaxes.FirstOrDefault(t => t.Id == id);
        if (taxToToggle == null) return;

        taxToToggleId = id;
        confirmationModalTitle = "Confirmar Acción";
        confirmationModalMessage = $"¿Está seguro de que desea {(taxToToggle.EstaActivo ? "desactivar" : "activar")} el impuesto {taxToToggle.Nombre}?";
        showConfirmationModal = true;
    }

    private async Task ConfirmToggleTaxStatus()
    {
        showConfirmationModal = false;
        var taxToToggle = allTaxes.FirstOrDefault(t => t.Id == taxToToggleId);
        if (taxToToggle == null) return;

        try
        {
            await TaxService.DeleteTaxAsync(taxToToggleId);
            isSuccess = true;
            statusMessage = $"El impuesto '{taxToToggle.Nombre}' ha sido {(taxToToggle.EstaActivo ? "desactivado" : "activado")} correctamente.";
            await LoadTaxes();
        }
        catch (Exception ex)
        {
            isSuccess = false;
            statusMessage = $"Error: {ex.Message}";
        }
    }

    private void CancelToggleTaxStatus()
    {
        showConfirmationModal = false;
        taxToToggleId = Guid.Empty;
    }

    private void ClearStatusMessage()
    {
        statusMessage = null;
        StateHasChanged();
    }

    private void GoToCreateTax()
    {
        Navigation.NavigateTo("/taxes/create");
    }
}
@page "/invoices/create"
@attribute [Authorize]
@using FacturasSRI.Application.Dtos
@using FacturasSRI.Application.Interfaces
@inject IInvoiceService InvoiceService
@inject ICustomerService CustomerService
@inject IProductService ProductService
@inject NavigationManager Navigation

<PageTitle>Crear Factura</PageTitle>

<div class="page-header">
    <h1>Crear Nueva Factura</h1>
    <p>Sigue los pasos para emitir una nueva factura electr칩nica.</p>
</div>

@if (errorMessage != null)
{
    <div class="alert alert-danger">@errorMessage</div>
}

<div class="card">
    <div class="card-body">
        
        <!-- Step 1: Customer -->
        <div class="step-section">
            <div class="step-number">1</div>
            <div class="step-content">
                <h4 class="step-title">Buscar Cliente</h4>
                <input type="text" class="form-control" placeholder="Escriba para buscar cliente por nombre o RUC..." 
                       @bind="customerSearchTerm" @bind:event="oninput" @onkeyup="SearchCustomers" />

                @if (customerSearchResults.Any())
                {
                    <ul class="list-group search-results">
                        @foreach (var customer in customerSearchResults)
                        {
                            <li class="list-group-item list-group-item-action" @onclick="() => SelectCustomer(customer)">
                                @customer.RazonSocial (@customer.NumeroIdentificacion)
                            </li>
                        }
                    </ul>
                }

                @if (selectedCustomer != null)
                {
                    <div class="alert alert-light selected-item-info mt-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>Cliente Seleccionado:</strong> @selectedCustomer.RazonSocial<br/>
                                <small>@selectedCustomer.NumeroIdentificacion | @selectedCustomer.Email</small>
                            </div>
                            <button class="btn btn-sm btn-outline-danger" @onclick="ClearCustomer">
                                <i class="bi bi-x-lg"></i>
                            </button>
                        </div>
                    </div>
                }
            </div>
        </div>

        <hr/>

        <!-- Step 2: Products -->
        <div class="step-section">
            <div class="step-number">2</div>
            <div class="step-content">
                <h4 class="step-title">A침adir Productos</h4>
                <input type="text" class="form-control" placeholder="Escriba para buscar producto por nombre o c칩digo..." 
                       @bind="productSearchTerm" @bind:event="oninput" @onkeyup="SearchProducts" disabled="@(selectedCustomer == null)"/>

                @if (productSearchResults.Any())
                {
                     <ul class="list-group search-results">
                        @foreach (var product in productSearchResults)
                        {
                            <li class="list-group-item list-group-item-action" @onclick="() => AddItem(product)">
                                @product.Nombre (@product.CodigoPrincipal) - <strong>@product.PrecioVentaUnitario.ToString("C")</strong>
                            </li>
                        }
                    </ul>
                }
            </div>
        </div>
        
        <!-- Step 3: Invoice Items & Summary -->
        @if (invoiceItems.Any())
        {
            <div class="step-section">
                <div class="step-number">3</div>
                <div class="step-content">
                    <h4 class="step-title">Resumen de Factura</h4>
                    <div class="table-responsive">
                        <table class="table invoice-items-table">
                            <thead>
                                <tr>
                                    <th>Producto</th>
                                    <th style="width: 120px;">Cantidad</th>
                                    <th class="text-end">Precio Unit.</th>
                                    <th class="text-end">Subtotal</th>
                                    <th class="text-center">Quitar</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var item in invoiceItems)
                                {
                                    <tr>
                                        <td>@item.ProductName</td>
                                        <td>
                                            <InputNumber class="form-control form-control-sm" @bind-Value="item.Cantidad" @oninput="UpdateTotals" />
                                        </td>
                                        <td class="text-end">@item.PrecioVentaUnitario.ToString("C")</td>
                                        <td class="text-end">@((item.Cantidad * item.PrecioVentaUnitario).ToString("C"))</td>
                                        <td class="text-center">
                                            <button class="btn btn-sm btn-outline-danger" @onclick="() => RemoveItem(item.ProductoId)">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>

                    <div class="row justify-content-end">
                        <div class="col-md-5">
                            <ul class="list-group">
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    Subtotal
                                    <span>@subtotal.ToString("C")</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    IVA (12%)
                                    <span>@iva.ToString("C")</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center active">
                                    <strong>Total</strong>
                                    <strong>@total.ToString("C")</strong>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        }
        
        <hr/>

        <div class="d-flex justify-content-end mt-4">
            <button class="btn btn-secondary me-2" @onclick='() => Navigation.NavigateTo("/invoices")'>
                <i class="bi bi-x-circle me-2"></i>Cancelar
            </button>
            <button class="btn btn-primary" @onclick="HandleCreateInvoice" disabled="@(!invoiceItems.Any() || selectedCustomer == null || isSubmitting)">
                 @if (isSubmitting)
                {
                    <span class="spinner-border spinner-border-sm me-2"></span> 
                    <span>Generando...</span>
                }
                else
                {
                    <i class="bi bi-check-circle-fill me-2"></i>
                    <span>Generar Factura</span>
                }
            </button>
        </div>
    </div>
</div>


@code {
    private string? errorMessage;
    private bool isSubmitting = false;

    private List<CustomerDto> allCustomers = new();
    private List<ProductDto> allProducts = new();

    private string customerSearchTerm = string.Empty;
    private List<CustomerDto> customerSearchResults = new();
    private CustomerDto? selectedCustomer;

    private string productSearchTerm = string.Empty;
    private List<ProductDto> productSearchResults = new();

    private List<InvoiceItemViewModel> invoiceItems = new();
    
    private decimal subtotal = 0;
    private decimal iva = 0;
    private decimal total = 0;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            allCustomers = await CustomerService.GetCustomersAsync();
            allProducts = await ProductService.GetProductsAsync();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error al cargar datos iniciales: {ex.Message}";
        }
    }

    private void SearchCustomers()
    {
        if (string.IsNullOrWhiteSpace(customerSearchTerm))
        {
            customerSearchResults.Clear();
            return;
        }
        customerSearchResults = allCustomers
            .Where(c => c.RazonSocial.Contains(customerSearchTerm, StringComparison.OrdinalIgnoreCase) || 
                        c.NumeroIdentificacion.Contains(customerSearchTerm))
            .Take(5)
            .ToList();
    }

    private void SelectCustomer(CustomerDto customer)
    {
        selectedCustomer = customer;
        customerSearchTerm = string.Empty;
        customerSearchResults.Clear();
    }
    
    private void ClearCustomer()
    {
        selectedCustomer = null;
    }

    private void SearchProducts()
    {
        if (string.IsNullOrWhiteSpace(productSearchTerm))
        {
            productSearchResults.Clear();
            return;
        }
        productSearchResults = allProducts
            .Where(p => p.Nombre.Contains(productSearchTerm, StringComparison.OrdinalIgnoreCase) || 
                        p.CodigoPrincipal.Contains(productSearchTerm, StringComparison.OrdinalIgnoreCase))
            .Take(5)
            .ToList();
    }

    private void AddItem(ProductDto product)
    {
        var existingItem = invoiceItems.FirstOrDefault(i => i.ProductoId == product.Id);
        if (existingItem != null)
        {
            existingItem.Cantidad++;
        }
        else
        {
            invoiceItems.Add(new InvoiceItemViewModel
            {
                ProductoId = product.Id,
                ProductName = product.Nombre,
                Cantidad = 1,
                PrecioVentaUnitario = product.PrecioVentaUnitario
            });
        }
        
        productSearchTerm = string.Empty;
        productSearchResults.Clear();
        UpdateTotals();
    }
    
    private void RemoveItem(Guid productId)
    {
        var item = invoiceItems.FirstOrDefault(i => i.ProductoId == productId);
        if (item != null)
        {
            invoiceItems.Remove(item);
            UpdateTotals();
        }
    }

    private void UpdateTotals()
    {
        subtotal = invoiceItems.Sum(i => i.Cantidad * i.PrecioVentaUnitario);
        
        // This is a simplified IVA calculation. A real implementation would check each product's taxes.
        iva = subtotal * 0.12m; 

        total = subtotal + iva;
        StateHasChanged();
    }

    private async Task HandleCreateInvoice()
    {
        isSubmitting = true;
        errorMessage = null;

        if (selectedCustomer == null || !invoiceItems.Any())
        {
            errorMessage = "Debe seleccionar un cliente y a침adir al menos un producto.";
            isSubmitting = false;
            return;
        }

        var createDto = new CreateInvoiceDto
        {
            ClienteId = selectedCustomer.Id,
            Items = invoiceItems.Select(i => new InvoiceItemDto
            {
                ProductoId = i.ProductoId,
                Cantidad = i.Cantidad
            }).ToList()
        };

        try
        {
            await InvoiceService.CreateInvoiceAsync(createDto);
            Navigation.NavigateTo("/invoices");
        }
        catch (Exception ex)
        {
            errorMessage = $"Error al generar la factura: {ex.Message}";
        }
        finally
        {
            isSubmitting = false;
        }
    }

    public class InvoiceItemViewModel
    {
        public Guid ProductoId { get; set; }
        public string ProductName { get; set; } = string.Empty;
        public int Cantidad { get; set; }
        public decimal PrecioVentaUnitario { get; set; }
    }
}
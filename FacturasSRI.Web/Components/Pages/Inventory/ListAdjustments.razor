@page "/inventory/adjustments"
@attribute [Authorize(Roles = "Administrador, Bodeguero")]
@using FacturasSRI.Application.Dtos
@using FacturasSRI.Application.Interfaces
@inject IAjusteInventarioService AjusteInventarioService

<PageTitle>Historial de Ajustes</PageTitle>

<div class="page-header">
    <h1>Historial de Ajustes de Inventario</h1>
    <p>Consulta todos los movimientos de ajuste registrados en el sistema.</p>
</div>

<div class="mb-3">
    <input type="text" class="form-control" placeholder="Buscar ajustes por producto o motivo..." @bind-value="searchTerm" @bind-value:event="oninput" />
</div>

@if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="alert alert-danger mb-4" role="alert">
        @errorMessage
        <button type="button" class="btn-close float-end" @onclick="ClearErrorMessage" aria-label="Close"></button>
    </div>
}

@if (isLoading)
{
    <p><em>Cargando historial de ajustes...</em></p>
}
else if (FilteredAdjustments.Any()) // Use FilteredAdjustments
{
    <div class="card">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Producto</th>
                            <th>Tipo</th>
                            <th class="text-end">Cantidad</th>
                            <th>Motivo</th>
                            <th>Autorizado Por</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var ajuste in FilteredAdjustments) // Use FilteredAdjustments
                        {
                            <tr>
                                <td>@ajuste.Fecha.ToLocalTime().ToString("g")</td>
                                <td>@ajuste.ProductoNombre</td>
                                <td>@ajuste.Tipo</td>
                                <td class="text-end">@ajuste.CantidadAjustada</td>
                                <td>@ajuste.Motivo</td>
                                <td>@ajuste.UsuarioAutoriza</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
}
else
{
    <p>No se han registrado ajustes de inventario todavía.</p>
}
@code {
    private List<AjusteListItemDto> allAdjustments = new(); // Holds all adjustments
    private bool isLoading = true;
    private string? errorMessage; // New

    private string searchTerm = string.Empty; // New property for search

    private List<AjusteListItemDto> FilteredAdjustments => string.IsNullOrWhiteSpace(searchTerm)
        ? allAdjustments
        : allAdjustments.Where(a => a.ProductoNombre.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
                                    a.Motivo.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
                                    a.UsuarioAutoriza.Contains(searchTerm, StringComparison.OrdinalIgnoreCase))
                      .ToList();

    protected override async Task OnInitializedAsync()
    {
        try
        {
            allAdjustments = await AjusteInventarioService.GetAdjustmentsAsync(); // Load all adjustments
        }
        catch (Exception ex)
        {
            errorMessage = $"No se pudieron cargar los ajustes de inventario. Por favor, inténtelo de nuevo. Si el problema persiste, contacte a soporte técnico. Detalles: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private void ClearErrorMessage()
    {
        errorMessage = null;
        StateHasChanged();
    }
}